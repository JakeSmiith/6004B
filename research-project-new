cd "C:\Users\jakes\Downloads"
tempfile daily mon quart
import excel using "VIX_historical.xlsx", sheet("Daily") firstrow clear
gen date = observation_date
format date %tdNN/DD/CCYY
gen freq = "daily"
drop observation_date
rename VIXCLS  vix
rename T10Y2Y  t10y2y
rename T10YIE  t10yie
rename WTI     wti
rename BC      brent
tsset date, daily
save `daily', replace
list date brent in 1/15
save `daily', replace

import excel using "VIX_historical.xlsx", sheet("Monthly") firstrow clear
rename observation_date date
list date WHEAT in 1/15
rename TB3S    tbill3m
rename HHNG    natgas
rename CORN    corn
rename WHEAT   wheat
rename SOYBEAN soybean
gen date = observation_date
format date %tdNN/DD/CCYY
tsset date, daily
tsfill
ipolate tbill3m   date, gen(tb3m_d)
ipolate natgas    date, gen(natgas_d)
ipolate corn      date, gen(corn_d)
ipolate wheat     date, gen(wheat_d)
ipolate soybean   date, gen(soybean_d)
list date tb3m_d natgas_d corn_d wheat_d soybean_d if inrange(date, td(01jan1990), td(15jan1990)), clean noobs
save `mon', replace

import excel using "VIX_historical.xlsx", sheet("Quarterly") firstrow clear
gen date = observation_date
format date %tdNN/DD/CCYY
tsset date, daily
tsfill
ipolate gdp date, gen(gdp_d)
list date gdp gdp_d if inrange(date, td(01jan1990), td(15jan1990)), clean noobs
save `quart', replace

clear
use `daily'
merge 1:1 date using "`mon'"
drop _merge
merge 1:1 date using "`quart'"
save vix_all_frequencies.dta, replace

list date gdp_d wheat_d in 1/15

use vix_all_frequencies.dta, clear
encode freq, gen(panel)
xtset panel date
xtdescribe

xtile decile = vix, nq(10)
gen crisis10 = decile == 10
label define cris_lbl2 0 "Normal" 1 "Crisis"
label values crisis10 cris_lbl2

quietly sum vix, detail
local p90 = r(p90)
histogram vix, bin(50) normal xline(`p90', lcolor(red) lpattern(dash)) title("VIX Distribution with Top-Decile Cutoff") xtitle("VIX Level") ytitle("Frequency") note("Red line marks the minimum VIX value in the top decile (`=string(`p90',"%9.2f")')")
save vix_all_frequencies.dta, replace

import delimited "C:\Users\jakes\Downloads\sp500.csv", varnames(1) clear
rename date date_str
gen date = date(date_str, "DMY")
format date %tdNN/DD/CCYY
list date_str adjusted_close in 1/15
drop date_str
keep date adjusted_close
rename adjusted_close sp_adjclose
save "sp_returns.dta", replace

use vix_all_frequencies.dta, clear
drop _merge
merge 1:1 date using sp_full.dta
drop _merge
tsset date, daily
drop if missing(brent)
list brent soybean_d gdp_d date in 1/15

sort date
gen ln_sp500 = log(sp_adjclose)
gen r_sp = 100*(ln_sp500 - ln_sp500[_n-1])
list date sp_adjclose ln_sp500 r_sp in 1/15, clean noobs
save vix_all_frequencies.dta, replace

sort date
gen log_natgas_d = ln(natgas_d)
gen log_corn_d = ln(corn_d)
gen log_wheat_d = ln(wheat_d)
gen log_soybean_d = ln(soybean_d)
gen log_brent = ln(brent)
gene log_wti = ln(wti)

generate byte bad_log = (natgas_d<=0 | corn_d<=0 | wheat_d<=0 | soybean_d<=0 | brent<=0 | wti<=0)
list date if bad_log
list log_corn_d log_soybean_d log_wti date in 1/15

sort date
gen r_natgas_d  = 100*(log_natgas_d - log_natgas_d[_n-1])
gen r_corn_d = 100*(log_corn_d - log_corn_d[_n-1])
gen r_wheat_d = 100*(log_wheat_d - log_wheat_d[_n-1])
gen r_soybean_d = 100*(log_soybean_d - log_soybean_d[_n-1])
gen r_brent = 100*(log_brent - log_brent[_n-1])
gen r_wti = 100*(log_wti - log_wti[_n-1])
drop if _n==1

reg r_brent r_sp, robust
foreach a in brent wti natgas corn wheat soybean {
    local ra = "r_`a'"
    display "=== Regression of `ra' on market ==="
    reg `ra' r_sp, robust
}

reg r_brent c.r_sp##i.crisis10, robust
local assets natgas_d corn_d wheat_d soybean_d brent wti
foreach a of local assets {
    di as txt "===== `a' (VIX top-decile crisis) ====="
    reg r_`a' c.r_sp##i.crisis10, robust
    di as txt ""
}

gen crisisGFC   = inrange(date, td(15sep2008), td(9mar2009))
gen crisisCOVID = inrange(date, td(20feb2020), td(30apr2020))
label var crisisGFC   "GFC: 15Sep2008–09Mar2009"
label var crisisCOVID "COVID-19: 20Feb2020–30Apr2020"
di as txt "=== Brent vs S&P during GFC ==="
reg  r_brent c.r_sp##i.crisisGFC, robust
di as txt ""
di as txt "=== Brent vs S&P during COVID-19 ==="
reg  r_brent c.r_sp##i.crisisCOVID, robust
foreach a in brent wti natgas corn wheat soybean {
    foreach per in GFC COVID {
        di as txt "=== `a': `per' window ==="
        reg r_`a' c.r_sp##i.crisis`per', robust
        di as txt ""
    }
}
save vix_all_frequencies.dta, replace

ssc install rangestat, replace
use vix_all_frequencies.dta, clear
tsset date

tempfile f_wti f_brent f_nat f_corn f_wheat f_soy

//WTI
preserve
rangestat (reg) r_wti    r_sp, interval(date -59 0)
keep date b_r_sp
rename b_r_sp beta60_r_wti
save `f_wti', replace
restore

//Brent
preserve
rangestat (reg) r_brent r_sp, interval(date -59 0)
keep date b_r_sp
rename b_r_sp beta60_r_brent
save `f_brent', replace
restore

//Natgas
preserve
rangestat (reg) r_natgas r_sp, interval(date -59 0)
keep date b_r_sp
rename b_r_sp beta60_r_natgas
save `f_nat', replace
restore

//Corn
preserve
rangestat (reg) r_corn  r_sp, interval(date -59 0)
keep date b_r_sp
rename b_r_sp beta60_r_corn
save `f_corn', replace
restore

//Wheat
preserve
rangestat (reg) r_wheat r_sp, interval(date -59 0)
keep date b_r_sp
rename b_r_sp beta60_r_wheat
save `f_wheat', replace
restore

//Soybean
preserve
rangestat (reg) r_soybean r_sp, interval(date -59 0)
keep date b_r_sp
rename b_r_sp beta60_r_soybean
save `f_soy', replace
restore

merge 1:1 date using `f_wti'
drop _merge
merge 1:1 date using `f_brent'
drop _merge
merge 1:1 date using `f_nat'
drop _merge
merge 1:1 date using `f_corn'
drop _merge
merge 1:1 date using `f_wheat'
drop _merge
merge 1:1 date using `f_soy'
drop _merge

list date beta60_* in 60/70, clean noobs

tempfile f_wti30 f_brent30 f_nat30 f_corn30 f_wheat30 f_soy30 

// WTI 30-day
preserve
  rangestat (reg) r_wti    r_sp, interval(date -29 0)
  keep date b_r_sp
  rename b_r_sp beta30_r_wti
  save `f_wti30', replace
restore

// Brent 30-day
preserve
  rangestat (reg) r_brent  r_sp, interval(date -29 0)
  keep date b_r_sp
  rename b_r_sp beta30_r_brent
  save `f_brent30', replace
restore

// NatGas 30-day 
preserve
  rangestat (reg) r_natgas r_sp, interval(date -29 0)
  keep date b_r_sp
  rename b_r_sp beta30_r_natgas
  save `f_nat30', replace
restore

// Corn 30-day 
preserve
  rangestat (reg) r_corn   r_sp, interval(date -29 0)
  keep date b_r_sp
  rename b_r_sp beta30_r_corn
  save `f_corn30', replace
restore

// Wheat 30-day 
preserve
  rangestat (reg) r_wheat  r_sp, interval(date -29 0)
  keep date b_r_sp
  rename b_r_sp beta30_r_wheat
  save `f_wheat30', replace
restore

// Soybean 30-day
preserve
  rangestat (reg) r_soybean r_sp, interval(date -29 0)
  keep date b_r_sp
  rename b_r_sp beta30_r_soybean
  save `f_soy30', replace
restore

merge 1:1 date using `f_wti30'
drop _merge
merge 1:1 date using `f_brent30'
drop _merge
merge 1:1 date using `f_nat30'
drop _merge
merge 1:1 date using `f_corn30'
drop _merge
merge 1:1 date using `f_wheat30'
drop _merge
merge 1:1 date using `f_soy30'
drop _merge


tempfile f_wti120 f_brent120 f_nat120 f_corn120 f_wheat120 f_soy120 

// WTI 120-day 
preserve
  rangestat (reg) r_wti    r_sp, interval(date -119 0)
  keep date b_r_sp
  rename b_r_sp beta120_r_wti
  save `f_wti120', replace
restore

// Brent 120-day 
preserve
  rangestat (reg) r_brent  r_sp, interval(date -119 0)
  keep date b_r_sp
  rename b_r_sp beta120_r_brent
  save `f_brent120', replace
restore

// NatGas 120-day 
preserve
  rangestat (reg) r_natgas r_sp, interval(date -119 0)
  keep date b_r_sp
  rename b_r_sp beta120_r_natgas
  save `f_nat120', replace
restore

// Corn 120-day
preserve
  rangestat (reg) r_corn   r_sp, interval(date -119 0)
  keep date b_r_sp
  rename b_r_sp beta120_r_corn
  save `f_corn120', replace
restore

// Wheat 120-day 
preserve
  rangestat (reg) r_wheat  r_sp, interval(date -119 0)
  keep date b_r_sp
  rename b_r_sp beta120_r_wheat
  save `f_wheat120', replace
restore

// Soybean 120-day 
preserve
  rangestat (reg) r_soybean r_sp, interval(date -119 0)
  keep date b_r_sp
  rename b_r_sp beta120_r_soybean
  save `f_soy120', replace
restore

merge 1:1 date using `f_wti120'
drop _merge
merge 1:1 date using `f_brent120'
drop _merge
merge 1:1 date using `f_nat120'
drop _merge
merge 1:1 date using `f_corn120'
drop _merge
merge 1:1 date using `f_wheat120'
drop _merge
merge 1:1 date using `f_soy120'
drop _merge

save vix_all_frequencies.dta, replace

tsset date

local assets wti brent natgas corn wheat soybean sp

set scheme journal
use vix_all_frequencies.dta, clear
tsset date
local assets wti brent natgas corn wheat soybean sp
local start30  = td(01feb1990)
local start60  = td(01mar1990)
local start120 = td(01may1990)
local end      = td(31dec2024)

foreach a in `assets' {
    local Asset = proper("`a'")
    if "`a'" == "sp" local Asset = "S&P500"
    twoway line beta30_r_`a' date if date>=`start30', lcolor(red) lwidth(medium) || line beta60_r_`a' date if date>=`start60', lcolor(blue) lwidth(medium) || line beta120_r_`a' date if date>=`start120', lcolor(black) lwidth(medium) yline(1, lpattern(dash) lcolor(red) lwidth(thin)) yscale(range(-3 3)) legend(order(1 "30-day" 2 "60-day" 3 "120-day") cols(1) size(vsmall)) title("Rolling β: `Asset' (30/60/120-day)", size(small)) subtitle("Feb/Mar/May 1990–Dec 2024", size(vsmall) color(gs8)) xtitle("Date", size(vsmall)) ytitle("β", size(vsmall)) xlabel(, format(%tdCY) labsize(vsmall) angle(45) grid) ylabel(-3(1)3, labsize(vsmall) angle(horizontal) grid) graphregion(color(white)) bgcolor(white) name(rolling_`a', replace)
    graph save rolling_beta30_60_120_`a'.gph, replace
    graph export rolling_beta30_60_120_`a'.png, replace width(1200)
}

// natural gas + brent + wti 30
twoway (line beta30_r_wti    date if date>=`start30', lcolor(red)   lwidth(medium)) (line beta30_r_brent date if date>=`start30', lcolor(blue)  lwidth(medium)) (line beta30_r_natgas date if date>=`start30', lcolor(black) lwidth(medium)), yline(1, lpattern(dash) lcolor(red) lwidth(thin)) yscale(range(-3 3)) legend(order(1 "WTI" 2 "Brent" 3 "NatGas") cols(1) size(vsmall)) title("30-Day Rolling Beta: WTI vs. Brent vs. NatGas", size(small)) subtitle("Feb 1990–Dec 2024", size(vsmall) color(gs8)) xtitle("Date", size(vsmall)) ytitle("Beta", size(vsmall)) xlabel(, format(%tdCY) labsize(vsmall) angle(45) grid) ylabel(-3(1)3, labsize(vsmall) angle(horizontal) grid) graphregion(color(white)) bgcolor(white) name(beta30_wti_brent_natgas, replace)
graph save beta30_wti_brent_natgas.gph, replace

// soybean, corn wheat 30
twoway (line beta30_r_soybean date if date>=`start30', lcolor(red)   lwidth(medium)) (line beta30_r_wheat date if date>=`start30', lcolor(blue)  lwidth(medium)) (line beta30_r_corn    date if date>=`start30', lcolor(black) lwidth(medium)), yline(1, lpattern(dash) lcolor(red) lwidth(thin)) yscale(range(-3 3)) legend(order(1 "Soybean" 2 "Wheat" 3 "Corn") cols(1) size(vsmall)) title("30-Day Rolling Beta: Soybean, Wheat & Corn", size(small)) subtitle("Feb 1990–Dec 2024", size(vsmall) color(gs8)) xtitle("Date", size(vsmall)) ytitle("Beta", size(vsmall)) xlabel(, format(%tdCY) labsize(vsmall) angle(45) grid) ylabel(-3(1)3, labsize(vsmall) angle(horizontal) grid) graphregion(color(white)) bgcolor(white) name(beta30_soy_wheat_corn, replace)
graph save beta30_soy_wheat_corn.gph, replace

//60
twoway (line beta60_r_wti    date if date>=`start60', lcolor(red)   lwidth(medium)) (line beta60_r_brent date if date>=`start60', lcolor(blue)  lwidth(medium)) (line beta60_r_natgas  date if date>=`start60', lcolor(black) lwidth(medium)), yline(1, lpattern(dash) lcolor(red) lwidth(thin)) yscale(range(-3 3)) legend(order(1 "WTI" 2 "Brent" 3 "NatGas") cols(1) size(vsmall)) title("60-Day Rolling Beta: WTI vs. Brent vs. NatGas", size(small)) subtitle("Mar 1990–Dec 2024", size(vsmall) color(gs8)) xtitle("Date", size(vsmall)) ytitle("Beta", size(vsmall)) xlabel(, format(%tdCY) labsize(vsmall) angle(45) grid) ylabel(-3(1)3, labsize(vsmall)) graphregion(color(white)) bgcolor(white) name(beta60_wti_brent_natgas, replace)
graph save beta60_wti_brent_natgas.gph, replace

twoway (line beta60_r_soybean date if date>=`start60', lcolor(red)   lwidth(medium)) (line beta60_r_wheat   date if date>=`start60', lcolor(blue)  lwidth(medium)) (line beta60_r_corn    date if date>=`start60', lcolor(black) lwidth(medium)), yline(1, lpattern(dash) lcolor(red) lwidth(thin)) yscale(range(-3 3)) legend(order(1 "Soybean" 2 "Wheat" 3 "Corn") cols(1) size(vsmall)) title("60-Day Rolling Beta: Soybean, Wheat & Corn", size(small)) subtitle("Mar 1990–Dec 2024", size(vsmall) color(gs8)) xtitle("Date", size(vsmall)) ytitle("Beta", size(vsmall)) xlabel(, format(%tdCY) labsize(vsmall) angle(45) grid) ylabel(-3(1)3, labsize(vsmall)) graphregion(color(white)) bgcolor(white) name(beta60_soy_wheat_corn, replace)
graph save beta60_soy_wheat_corn.gph, replace

//120
twoway (line beta120_r_wti    date if date>=`start120', lcolor(red)   lwidth(medium)) (line beta120_r_brent date if date>=`start120', lcolor(blue)  lwidth(medium)) (line beta120_r_natgas  date if date>=`start120', lcolor(black) lwidth(medium)), yline(1, lpattern(dash) lcolor(red) lwidth(thin)) yscale(range(-3 3)) legend(order(1 "WTI" 2 "Brent" 3 "NatGas") cols(1) size(vsmall)) title("120-Day Rolling Beta: WTI vs. Brent vs. NatGas", size(small)) subtitle("May 1990–Dec 2024", size(vsmall) color(gs8)) xtitle("Date", size(vsmall)) ytitle("Beta", size(vsmall)) xlabel(, format(%tdCY) labsize(vsmall) angle(45) grid) ylabel(-3(1)3, labsize(vsmall)) graphregion(color(white)) bgcolor(white) name(beta120_wti_brent_natgas, replace)
graph save beta120_wti_brent_natgas.gph, replace

twoway (line beta120_r_soybean date if date>=`start120', lcolor(red)   lwidth(medium)) (line beta120_r_wheat   date if date>=`start120', lcolor(blue)  lwidth(medium)) (line beta120_r_corn    date if date>=`start120', lcolor(black) lwidth(medium)), yline(1, lpattern(dash) lcolor(red) lwidth(thin)) yscale(range(-3 3)) legend(order(1 "Soybean" 2 "Wheat" 3 "Corn") cols(1) size(vsmall)) title("120-Day Rolling Beta: Soybean, Wheat & Corn", size(small)) subtitle("May 1990–Dec 2024", size(vsmall) color(gs8)) xtitle("Date", size(vsmall)) ytitle("Beta", size(vsmall)) xlabel(, format(%tdCY) labsize(vsmall) angle(45) grid) ylabel(-3(1)3, labsize(vsmall)) graphregion(color(white)) bgcolor(white) name(beta120_soy_wheat_corn, replace)
graph save beta120_soy_wheat_corn.gph, replace

//Shaders applied
gen shade_hi =  3 if crisis10==1
gen shade_lo = -3 if crisis10==0
twoway rarea shade_hi shade_lo date if crisis10==1 & date>=`start30', color(gs12) || line beta30_r_wti date if date>=`start30', lcolor(red) lwidth(medium) title("WTI: 30-Day Rolling Beta (shaded = crisis only)", size(small)) subtitle("Feb 1990–Dec 2024", size(vsmall) color(gs8)) xtitle("Date", size(vsmall)) ytitle("Beta", size(vsmall)) xlabel(, format(%tdCY) labsize(vsmall) angle(45) grid) ylabel(-3(1)3, labsize(vsmall) angle(horizontal) grid) legend(off) name(shade30_wti, replace)

gen crisis_period = crisisGFC | crisisCOVID
gen shade_hi =  3 if crisis_period
gen shade_lo = -3 if crisis_period





















