cd "C:\Users\jakes\Downloads"
tempfile daily mon quart
import excel using "VIX_historical.xlsx", sheet("Daily") firstrow clear
gen date = observation_date
format date %tdNN/DD/CCYY
gen freq = "daily"
drop observation_date
rename VIXCLS  vix
rename T10Y2Y  t10y2y
rename T10YIE  t10yie
rename WTI     wti
rename BC      brent
tsset date, daily
save `daily', replace
list date brent in 1/15
save `daily', replace

import excel using "VIX_historical.xlsx", sheet("Monthly") firstrow clear
rename observation_date date
list date WHEAT in 1/15
rename TB3S    tbill3m
rename HHNG    natgas
rename CORN    corn
rename WHEAT   wheat
rename SOYBEAN soybean
gen date = observation_date
format date %tdNN/DD/CCYY
tsset date, daily
tsfill
ipolate tbill3m   date, gen(tb3m_d)
ipolate natgas    date, gen(natgas_d)
ipolate corn      date, gen(corn_d)
ipolate wheat     date, gen(wheat_d)
ipolate soybean   date, gen(soybean_d)
list date tb3m_d natgas_d corn_d wheat_d soybean_d if inrange(date, td(01jan1990), td(15jan1990)), clean noobs
save `mon', replace

import excel using "VIX_historical.xlsx", sheet("Quarterly") firstrow clear
gen date = observation_date
format date %tdNN/DD/CCYY
tsset date, daily
tsfill
ipolate gdp date, gen(gdp_d)
list date gdp gdp_d if inrange(date, td(01jan1990), td(15jan1990)), clean noobs
save `quart', replace

clear
use `daily'
merge 1:1 date using "`mon'"
drop _merge
merge 1:1 date using "`quart'"
save vix_all_frequencies.dta, replace

list date gdp_d wheat_d in 1/15

use vix_all_frequencies.dta, clear
encode freq, gen(panel)
xtset panel date
xtdescribe

xtile decile = vix, nq(10)
gen crisis10 = decile == 10
label define cris_lbl2 0 "Normal" 1 "Crisis"
label values crisis10 cris_lbl2

quietly sum vix, detail
local p90 = r(p90)
histogram vix, bin(50) normal xline(`p90', lcolor(red) lpattern(dash)) title("VIX Distribution with Top-Decile Cutoff") xtitle("VIX Level") ytitle("Frequency") note("Red line marks the minimum VIX value in the top decile (`=string(`p90',"%9.2f")')")
save vix_all_frequencies.dta, replace

import delimited "C:\Users\jakes\Downloads\sp500.csv", varnames(1) clear
rename date date_str
gen date = date(date_str, "DMY")
format date %tdNN/DD/CCYY
list date_str adjusted_close in 1/15
drop date_str
keep date adjusted_close
rename adjusted_close sp_adjclose
save "sp_returns.dta", replace

use vix_all_frequencies.dta, clear
drop _merge
merge 1:1 date using sp_full.dta
drop _merge
tsset date, daily
drop if missing(brent)
list brent soybean_d gdp_d date in 1/15

sort date
gen ln_sp500 = log(sp_adjclose)
gen r_sp = 100*(ln_sp500 - ln_sp500[_n-1])
list date sp_adjclose ln_sp500 r_sp in 1/15, clean noobs
save vix_all_frequencies.dta, replace

sort date
gen log_natgas_d = ln(natgas_d)
gen log_corn_d = ln(corn_d)
gen log_wheat_d = ln(wheat_d)
gen log_soybean_d = ln(soybean_d)
gen log_brent = ln(brent)
gene log_wti = ln(wti)

generate byte bad_log = (natgas_d<=0 | corn_d<=0 | wheat_d<=0 | soybean_d<=0 | brent<=0 | wti<=0)
list date if bad_log
list log_corn_d log_soybean_d log_wti date in 1/15

sort date
gen r_natgas_d  = 100*(log_natgas_d - log_natgas_d[_n-1])
gen r_corn_d = 100*(log_corn_d - log_corn_d[_n-1])
gen r_wheat_d = 100*(log_wheat_d - log_wheat_d[_n-1])
gen r_soybean_d = 100*(log_soybean_d - log_soybean_d[_n-1])
gen r_brent = 100*(log_brent - log_brent[_n-1])
gen r_wti = 100*(log_wti - log_wti[_n-1])
drop if _n==1

ssc install estout, replace
eststo clear
cd "C:\stata_output"
reg r_brent r_sp, robust
eststo r_brent
foreach a in wti natgas corn wheat soybean {
    reg r_`a' r_sp, robust
    eststo r_`a'
}
esttab r_brent r_wti r_natgas r_corn r_wheat r_soybean using market_regressions.rtf, replace se star(* 0.10 ** 0.05 *** 0.01) label b(3) se(3) title("Baseline Regressions: Asset Returns on Market Return") mtitles("Brent" "WTI" "Natural Gas" "Corn" "Wheat" "Soybean") coeflabels(r_sp "Market Return") keep(r_sp) compress nonumbers addnotes("Robust standard errors in parentheses." "Significance: * p<0.10; ** p<0.05; *** p<0.01")

reg r_brent c.r_sp##i.crisis10, robust
eststo r_brent
local assets natgas_d corn_d wheat_d soybean_d brent wti
foreach a of local assets {
    reg r_`a' c.r_sp##i.crisis10, robust
    eststo `a'
}
esttab natgas_d corn_d wheat_d soybean_d brent wti using crisis_interaction_regressions.rtf, replace se star(* 0.10 ** 0.05 *** 0.01) label b(3) se(3) title("Interaction Regressions: Asset Returns × VIX Top-Decile Crisis") mtitles("NatGas" "Corn" "Wheat" "Soybean" "Brent" "WTI") coeflabels(1.r_sp "Market (Normal)" 1.crisis10 "Crisis" r_sp#1.crisis10 "Market × Crisis") compress nonumbers addnotes("Robust standard errors in parentheses." "Significance: * p<0.10; ** p<0.05; *** p<0.01")


gen crisisGFC   = inrange(date, td(15sep2008), td(9mar2009))
gen crisisCOVID = inrange(date, td(20feb2020), td(30apr2020))
label var crisisGFC   "GFC: 15Sep2008–09Mar2009"
label var crisisCOVID "COVID-19: 20Feb2020–30Apr2020"

di as txt "=== Brent vs S&P during GFC ==="
reg  r_brent c.r_sp##i.crisisGFC, robust
di as txt ""
di as txt "=== Brent vs S&P during COVID-19 ==="
reg  r_brent c.r_sp##i.crisisCOVID, robust
foreach a in brent wti natgas corn wheat soybean {
    foreach per in GFC COVID {
        di as txt "=== `a': `per' window ==="
        reg r_`a' c.r_sp##i.crisis`per', robust
        di as txt ""
    }
}
save vix_all_frequencies.dta, replace

ssc install rangestat, replace
use vix_all_frequencies.dta, clear
tsset date

tempfile f_wti f_brent f_nat f_corn f_wheat f_soy

//Calculating observation number for GFC and Covid19
sort date
gen obs_no = _n
list date obs_no if date == td(15sep2008) | date == td(9mar2009), clean noobs
list date obs_no if date == td(20feb2020) | date == td(30apr2020), clean noobs

//Just GFC
reg r_brent r_sp in 4754/4874, robust
eststo r_brent
foreach a in wti natgas corn wheat soybean {
    reg r_`a' r_sp in 4754/4874, robust
    eststo r_`a'
}
esttab r_brent r_wti r_natgas r_corn r_wheat r_soybean using gfc_subsample_regressions.rtf, replace se star(* 0.10 ** 0.05 *** 0.01) label b(3) se(3) title("GFC Subsample Regressions: Asset Returns on Market Return (Sep 2008–Mar 2009)") mtitles("Brent" "WTI" "Natural Gas" "Corn" "Wheat" "Soybean") coeflabels(r_sp "Market Return") keep(r_sp) compress nonumbers addnotes("Sample: Obs 4754–4874 (GFC Window)", "Robust standard errors in parentheses.", "Significance: * p<0.10; ** p<0.05; *** p<0.01")

// Just Covid
reg r_brent r_sp in 7647/7695, robust
eststo r_brent
foreach a in wti natgas corn wheat soybean {
    reg r_`a' r_sp in 7647/7695, robust
    eststo r_`a'
}
esttab r_brent r_wti r_natgas r_corn r_wheat r_soybean using covid_subsample_regressions.rtf, replace se star(* 0.10 ** 0.05 *** 0.01) label b(3) se(3) title("COVID Subsample Regressions: Asset Returns on Market Return (Feb–Apr 2020)") mtitles("Brent" "WTI" "Natural Gas" "Corn" "Wheat" "Soybean") coeflabels(r_sp "Market Return") keep(r_sp) compress nonumbers addnotes("Sample: Obs 7647–7695 (COVID Window)", "Robust standard errors in parentheses.", "Significance: * p<0.10; ** p<0.05; *** p<0.01")

// GFC + Covid
gen combined_crisis_sample = 0
replace combined_crisis_sample = 1 if inrange(_n, 4754, 4874)
replace combined_crisis_sample = 1 if inrange(_n, 7647, 7695)
reg r_brent r_sp if combined_crisis_sample == 1, robust
eststo r_brent
foreach a in wti natgas corn wheat soybean {
    reg r_`a' r_sp if combined_crisis_sample == 1, robust
    eststo r_`a'
}
esttab r_brent r_wti r_natgas r_corn r_wheat r_soybean using crisis_sample_subsample_regressions.rtf, replace se star(* 0.10 ** 0.05 *** 0.01) label b(3) se(3) title("Crisis Subsample Regressions: Asset Returns on Market Return (GFC + COVID)") mtitles("Brent" "WTI" "Natural Gas" "Corn" "Wheat" "Soybean") coeflabels(r_sp "Market Return") keep(r_sp) compress nonumbers addnotes("Sample: Obs 4754–4874 (GFC) and 7647–7695 (COVID)", "Robust standard errors in parentheses.", "Significance: * p<0.10; ** p<0.05; *** p<0.01")

//Full table output

// Baseline
mkdir "C:\stata_output"
cd "C:\stata_output"
putdocx clear
putdocx begin
putdocx paragraph
putdocx text ("Baseline Regressions: Asset Returns on Market Return"), bold
foreach a in r_natgas_d r_corn_d r_wheat_d r_soybean_d r_brent r_wti {
    regress `a' r_sp, robust
    local shortname = substr("`a'",3,3)
    putdocx paragraph
    putdocx text ("Regression of `a' on Market Return"), italic
    putdocx table tbl_`shortname' = etable
    putdocx table tbl_`shortname'(1,.), halign(center)
}

putdocx save "baseline_regressions.docx", replace

// 90th percentile crisis interaction
mkdir "C:\stata_output"
cd "C:\stata_output"
putdocx clear
putdocx begin
putdocx paragraph
putdocx text ("Crisis Regressions: Asset Returns on Market Return × VIX Top Decile"), bold
local assets natgas_d corn_d wheat_d soybean_d brent wti
foreach a of local assets {
    regress r_`a' c.r_sp##i.crisis10, robust
    local shortname = substr("`a'", 1, 3)
    putdocx paragraph
    putdocx text ("Regression of r_`a' on Market Return × Crisis10"), italic
    putdocx table tblc_`shortname' = etable
    putdocx table tblc_`shortname'(1,.), halign(center)
}
putdocx save "crisis10_regressions.docx", replace

cd "C:\stata_output"
putdocx clear
putdocx begin

putdocx paragraph
putdocx text("GFC Subsample Regressions (15 Sep 2008 – 9 Mar 2009)"), bold

// Reg & Table output for just GFC

// Brent
reg r_brent r_sp in 4754/4874, robust
putdocx paragraph
putdocx text(`"r_brent regressed on r_sp during GFC"`), italic
putdocx table t1 = etable
putdocx table t1(1,.), halign(center)

// wti
reg r_wti r_sp in 4754/4874, robust
putdocx paragraph
putdocx text(`"r_wti regressed on r_sp during GFC"`), italic
putdocx table t2 = etable
putdocx table t2(1,.), halign(center)

// Natgas
reg r_natgas r_sp in 4754/4874, robust
putdocx paragraph
putdocx text(`"r_natgas regressed on r_sp during GFC"`), italic
putdocx table t3 = etable
putdocx table t3(1,.), halign(center)

// Corn
reg r_corn r_sp in 4754/4874, robust
putdocx paragraph
putdocx text(`"r_corn regressed on r_sp during GFC"`), italic
putdocx table t4 = etable
putdocx table t4(1,.), halign(center)

// Wheat
reg r_wheat r_sp in 4754/4874, robust
putdocx paragraph
putdocx text(`"r_wheat regressed on r_sp during GFC"`), italic
putdocx table t5 = etable
putdocx table t5(1,.), halign(center)

//Soybean
reg r_soybean r_sp in 4754/4874, robust
putdocx paragraph
putdocx text(`"r_soybean regressed on r_sp during GFC"`), italic
putdocx table t6 = etable
putdocx table t6(1,.), halign(center)
putdocx save "gfc_manual_regressions.docx", replace


// Covid
putdocx clear
putdocx begin
// Brent
reg r_brent r_sp in 7647/7695, robust
putdocx paragraph
putdocx text(`"r_brent regressed on r_sp during COVID-19"`), italic
putdocx table t1 = etable
putdocx table t1(1,.), halign(center)

// wti
reg r_wti r_sp in 7647/7695, robust
putdocx paragraph
putdocx text(`"r_wti regressed on r_sp during COVID-19"`), italic
putdocx table t2 = etable
putdocx table t2(1,.), halign(center)

// Natgas
reg r_natgas r_sp in 7647/7695, robust
putdocx paragraph
putdocx text(`"r_natgas regressed on r_sp during COVID-19"`), italic
putdocx table t3 = etable
putdocx table t3(1,.), halign(center)

// Corn
reg r_corn r_sp in 7647/7695, robust
putdocx paragraph
putdocx text(`"r_corn regressed on r_sp during COVID-19"`), italic
putdocx table t4 = etable
putdocx table t4(1,.), halign(center)

// Wheat
reg r_wheat r_sp in 7647/7695, robust
putdocx paragraph
putdocx text(`"r_wheat regressed on r_sp during COVID-19"`), italic
putdocx table t5 = etable
putdocx table t5(1,.), halign(center)

//Soybean
reg r_soybean r_sp in 7647/7695, robust
putdocx paragraph
putdocx text(`"r_soybean regressed on r_sp during COVID-19"`), italic
putdocx table t6 = etable
putdocx table t6(1,.), halign(center)
putdocx save "covid_manual_regressions.docx", replace


//Rolling Betas

//WTI
preserve
rangestat (reg) r_wti    r_sp, interval(date -59 0)
keep date b_r_sp
rename b_r_sp beta60_r_wti
save `f_wti', replace
restore

//Brent
preserve
rangestat (reg) r_brent r_sp, interval(date -59 0)
keep date b_r_sp
rename b_r_sp beta60_r_brent
save `f_brent', replace
restore

//Natgas
preserve
rangestat (reg) r_natgas r_sp, interval(date -59 0)
keep date b_r_sp
rename b_r_sp beta60_r_natgas
save `f_nat', replace
restore

//Corn
preserve
rangestat (reg) r_corn  r_sp, interval(date -59 0)
keep date b_r_sp
rename b_r_sp beta60_r_corn
save `f_corn', replace
restore

//Wheat
preserve
rangestat (reg) r_wheat r_sp, interval(date -59 0)
keep date b_r_sp
rename b_r_sp beta60_r_wheat
save `f_wheat', replace
restore

//Soybean
preserve
rangestat (reg) r_soybean r_sp, interval(date -59 0)
keep date b_r_sp
rename b_r_sp beta60_r_soybean
save `f_soy', replace
restore

merge 1:1 date using `f_wti'
drop _merge
merge 1:1 date using `f_brent'
drop _merge
merge 1:1 date using `f_nat'
drop _merge
merge 1:1 date using `f_corn'
drop _merge
merge 1:1 date using `f_wheat'
drop _merge
merge 1:1 date using `f_soy'
drop _merge

list date beta60_* in 60/70, clean noobs

tempfile f_wti30 f_brent30 f_nat30 f_corn30 f_wheat30 f_soy30 

// WTI 30-day
preserve
  rangestat (reg) r_wti    r_sp, interval(date -29 0)
  keep date b_r_sp
  rename b_r_sp beta30_r_wti
  save `f_wti30', replace
restore

// Brent 30-day
preserve
  rangestat (reg) r_brent  r_sp, interval(date -29 0)
  keep date b_r_sp
  rename b_r_sp beta30_r_brent
  save `f_brent30', replace
restore

// NatGas 30-day 
preserve
  rangestat (reg) r_natgas r_sp, interval(date -29 0)
  keep date b_r_sp
  rename b_r_sp beta30_r_natgas
  save `f_nat30', replace
restore

// Corn 30-day 
preserve
  rangestat (reg) r_corn   r_sp, interval(date -29 0)
  keep date b_r_sp
  rename b_r_sp beta30_r_corn
  save `f_corn30', replace
restore

// Wheat 30-day 
preserve
  rangestat (reg) r_wheat  r_sp, interval(date -29 0)
  keep date b_r_sp
  rename b_r_sp beta30_r_wheat
  save `f_wheat30', replace
restore

// Soybean 30-day
preserve
  rangestat (reg) r_soybean r_sp, interval(date -29 0)
  keep date b_r_sp
  rename b_r_sp beta30_r_soybean
  save `f_soy30', replace
restore

merge 1:1 date using `f_wti30'
drop _merge
merge 1:1 date using `f_brent30'
drop _merge
merge 1:1 date using `f_nat30'
drop _merge
merge 1:1 date using `f_corn30'
drop _merge
merge 1:1 date using `f_wheat30'
drop _merge
merge 1:1 date using `f_soy30'
drop _merge


tempfile f_wti120 f_brent120 f_nat120 f_corn120 f_wheat120 f_soy120 

// WTI 120-day 
preserve
  rangestat (reg) r_wti    r_sp, interval(date -119 0)
  keep date b_r_sp
  rename b_r_sp beta120_r_wti
  save `f_wti120', replace
restore

// Brent 120-day 
preserve
  rangestat (reg) r_brent  r_sp, interval(date -119 0)
  keep date b_r_sp
  rename b_r_sp beta120_r_brent
  save `f_brent120', replace
restore

// NatGas 120-day 
preserve
  rangestat (reg) r_natgas r_sp, interval(date -119 0)
  keep date b_r_sp
  rename b_r_sp beta120_r_natgas
  save `f_nat120', replace
restore

// Corn 120-day
preserve
  rangestat (reg) r_corn   r_sp, interval(date -119 0)
  keep date b_r_sp
  rename b_r_sp beta120_r_corn
  save `f_corn120', replace
restore

// Wheat 120-day 
preserve
  rangestat (reg) r_wheat  r_sp, interval(date -119 0)
  keep date b_r_sp
  rename b_r_sp beta120_r_wheat
  save `f_wheat120', replace
restore

// Soybean 120-day 
preserve
  rangestat (reg) r_soybean r_sp, interval(date -119 0)
  keep date b_r_sp
  rename b_r_sp beta120_r_soybean
  save `f_soy120', replace
restore

merge 1:1 date using `f_wti120'
drop _merge
merge 1:1 date using `f_brent120'
drop _merge
merge 1:1 date using `f_nat120'
drop _merge
merge 1:1 date using `f_corn120'
drop _merge
merge 1:1 date using `f_wheat120'
drop _merge
merge 1:1 date using `f_soy120'
drop _merge

save vix_all_frequencies.dta, replace

tsset date

local assets wti brent natgas corn wheat soybean sp

set scheme journal
use vix_all_frequencies.dta, clear
tsset date
local assets wti brent natgas corn wheat soybean sp
local start30  = td(01feb1990)
local start60  = td(01mar1990)
local start120 = td(01may1990)
local end      = td(31dec2024)

foreach a in `assets' {
    local Asset = proper("`a'")
    if "`a'" == "sp" local Asset = "S&P500"
    twoway line beta30_r_`a' date if date>=`start30', lcolor(red) lwidth(medium) || line beta60_r_`a' date if date>=`start60', lcolor(blue) lwidth(medium) || line beta120_r_`a' date if date>=`start120', lcolor(black) lwidth(medium) yline(1, lpattern(dash) lcolor(red) lwidth(thin)) yscale(range(-3 3)) legend(order(1 "30-day" 2 "60-day" 3 "120-day") cols(1) size(vsmall)) title("Rolling β: `Asset' (30/60/120-day)", size(small)) subtitle("Feb/Mar/May 1990–Dec 2024", size(vsmall) color(gs8)) xtitle("Date", size(vsmall)) ytitle("β", size(vsmall)) xlabel(, format(%tdCY) labsize(vsmall) angle(45) grid) ylabel(-3(1)3, labsize(vsmall) angle(horizontal) grid) graphregion(color(white)) bgcolor(white) name(rolling_`a', replace)
    graph save rolling_beta30_60_120_`a'.gph, replace
    graph export rolling_beta30_60_120_`a'.png, replace width(1200)
}

// natural gas + brent + wti 30
twoway (line beta30_r_wti    date if date>=`start30', lcolor(red)   lwidth(medium)) (line beta30_r_brent date if date>=`start30', lcolor(blue)  lwidth(medium)) (line beta30_r_natgas date if date>=`start30', lcolor(black) lwidth(medium)), yline(1, lpattern(dash) lcolor(red) lwidth(thin)) yscale(range(-3 3)) legend(order(1 "WTI" 2 "Brent" 3 "NatGas") cols(1) size(vsmall)) title("30-Day Rolling Beta: WTI vs. Brent vs. NatGas", size(small)) subtitle("Feb 1990–Dec 2024", size(vsmall) color(gs8)) xtitle("Date", size(vsmall)) ytitle("Beta", size(vsmall)) xlabel(, format(%tdCY) labsize(vsmall) angle(45) grid) ylabel(-3(1)3, labsize(vsmall) angle(horizontal) grid) graphregion(color(white)) bgcolor(white) name(beta30_wti_brent_natgas, replace)
graph save beta30_wti_brent_natgas.gph, replace

// soybean, corn wheat 30
twoway (line beta30_r_soybean date if date>=`start30', lcolor(red)   lwidth(medium)) (line beta30_r_wheat date if date>=`start30', lcolor(blue)  lwidth(medium)) (line beta30_r_corn    date if date>=`start30', lcolor(black) lwidth(medium)), yline(1, lpattern(dash) lcolor(red) lwidth(thin)) yscale(range(-3 3)) legend(order(1 "Soybean" 2 "Wheat" 3 "Corn") cols(1) size(vsmall)) title("30-Day Rolling Beta: Soybean, Wheat & Corn", size(small)) subtitle("Feb 1990–Dec 2024", size(vsmall) color(gs8)) xtitle("Date", size(vsmall)) ytitle("Beta", size(vsmall)) xlabel(, format(%tdCY) labsize(vsmall) angle(45) grid) ylabel(-3(1)3, labsize(vsmall) angle(horizontal) grid) graphregion(color(white)) bgcolor(white) name(beta30_soy_wheat_corn, replace)
graph save beta30_soy_wheat_corn.gph, replace

//60
twoway (line beta60_r_wti    date if date>=`start60', lcolor(red)   lwidth(medium)) (line beta60_r_brent date if date>=`start60', lcolor(blue)  lwidth(medium)) (line beta60_r_natgas  date if date>=`start60', lcolor(black) lwidth(medium)), yline(1, lpattern(dash) lcolor(red) lwidth(thin)) yscale(range(-3 3)) legend(order(1 "WTI" 2 "Brent" 3 "NatGas") cols(1) size(vsmall)) title("60-Day Rolling Beta: WTI vs. Brent vs. NatGas", size(small)) subtitle("Mar 1990–Dec 2024", size(vsmall) color(gs8)) xtitle("Date", size(vsmall)) ytitle("Beta", size(vsmall)) xlabel(, format(%tdCY) labsize(vsmall) angle(45) grid) ylabel(-3(1)3, labsize(vsmall)) graphregion(color(white)) bgcolor(white) name(beta60_wti_brent_natgas, replace)
graph save beta60_wti_brent_natgas.gph, replace

twoway (line beta60_r_soybean date if date>=`start60', lcolor(red)   lwidth(medium)) (line beta60_r_wheat   date if date>=`start60', lcolor(blue)  lwidth(medium)) (line beta60_r_corn    date if date>=`start60', lcolor(black) lwidth(medium)), yline(1, lpattern(dash) lcolor(red) lwidth(thin)) yscale(range(-3 3)) legend(order(1 "Soybean" 2 "Wheat" 3 "Corn") cols(1) size(vsmall)) title("60-Day Rolling Beta: Soybean, Wheat & Corn", size(small)) subtitle("Mar 1990–Dec 2024", size(vsmall) color(gs8)) xtitle("Date", size(vsmall)) ytitle("Beta", size(vsmall)) xlabel(, format(%tdCY) labsize(vsmall) angle(45) grid) ylabel(-3(1)3, labsize(vsmall)) graphregion(color(white)) bgcolor(white) name(beta60_soy_wheat_corn, replace)
graph save beta60_soy_wheat_corn.gph, replace

//120
twoway (line beta120_r_wti    date if date>=`start120', lcolor(red)   lwidth(medium)) (line beta120_r_brent date if date>=`start120', lcolor(blue)  lwidth(medium)) (line beta120_r_natgas  date if date>=`start120', lcolor(black) lwidth(medium)), yline(1, lpattern(dash) lcolor(red) lwidth(thin)) yscale(range(-3 3)) legend(order(1 "WTI" 2 "Brent" 3 "NatGas") cols(1) size(vsmall)) title("120-Day Rolling Beta: WTI vs. Brent vs. NatGas", size(small)) subtitle("May 1990–Dec 2024", size(vsmall) color(gs8)) xtitle("Date", size(vsmall)) ytitle("Beta", size(vsmall)) xlabel(, format(%tdCY) labsize(vsmall) angle(45) grid) ylabel(-3(1)3, labsize(vsmall)) graphregion(color(white)) bgcolor(white) name(beta120_wti_brent_natgas, replace)
graph save beta120_wti_brent_natgas.gph, replace

twoway (line beta120_r_soybean date if date>=`start120', lcolor(red)   lwidth(medium)) (line beta120_r_wheat   date if date>=`start120', lcolor(blue)  lwidth(medium)) (line beta120_r_corn    date if date>=`start120', lcolor(black) lwidth(medium)), yline(1, lpattern(dash) lcolor(red) lwidth(thin)) yscale(range(-3 3)) legend(order(1 "Soybean" 2 "Wheat" 3 "Corn") cols(1) size(vsmall)) title("120-Day Rolling Beta: Soybean, Wheat & Corn", size(small)) subtitle("May 1990–Dec 2024", size(vsmall) color(gs8)) xtitle("Date", size(vsmall)) ytitle("Beta", size(vsmall)) xlabel(, format(%tdCY) labsize(vsmall) angle(45) grid) ylabel(-3(1)3, labsize(vsmall)) graphregion(color(white)) bgcolor(white) name(beta120_soy_wheat_corn, replace)
graph save beta120_soy_wheat_corn.gph, replace

//Shaders applied
gen byte GFC   = inrange(date, td(15sep2008), td(9mar2009))
label var GFC  "Great Financial Crisis"
gen byte COVID = inrange(date, td(20feb2020), td(30apr2020))
label var COVID "COVID-19 shock"

local suffix    wti brent natgas corn wheat soybean
local pretty    WTI Brent "Natural gas" Corn Wheat Soybean
local cutoff    = td(1jan2025)

// Loop for GFC and Covid
local i = 1
foreach c of local suffix {
    local pname : word `i' of `pretty'
    quietly summarize beta60_r_`c' if date<`cutoff'
    local ymin = r(min)
    local ymax = r(max)
    tempvar shade
    gen double `shade' = (`ymax' - `ymin') if GFC==1 | COVID==1

    twoway (bar `shade' date if date<`cutoff', barwidth(1) base(`ymin') fcolor(gs12%30)) (line beta60_r_`c' date if date<`cutoff', lcolor(black) lwidth(medium)), scheme(s1color) title("`pname' 60-Day Rolling β", size(medium)) subtitle("Shaded: Great Financial Crisis & COVID-19", size(small)) xtitle("Date", size(small)) ytitle("β₆₀", size(small)) xlabel(, format(%tdCY) angle(45) labsize(vsmall)) ylabel(, grid labsize(vsmall)) yline(1, lpattern(dash) lcolor(red)) legend(off) graphregion(color(white)) plotregion(margin(5 5 5 5)) aspectratio(0.6) name(rolling60_`c', replace)

    local ++i
}

graph combine rolling60_wti rolling60_brent rolling60_natgas rolling60_corn rolling60_wheat rolling60_soybean, cols(3) xcommon ycommon imargin(zero) title("60-Day Rolling β for Oil, Gas & Grains") subtitle("Shaded: Great Financial Crisis & COVID-19") name(rolling60_all, replace)

//Loop for 90th percentile VIX method
foreach c of local suffix {
    local pname : word `i' of `pretty'
    quietly summarize beta60_r_`c' if date<`cutoff'
    local ymin = r(min)
    local ymax = r(max)
    tempvar shade
    gen double `shade' = (`ymax'-`ymin') if crisis10==1

    twoway (bar `shade' date if date<`cutoff', barwidth(1) base(`ymin') fcolor(gs12%20)) (line beta60_r_`c' date if date<`cutoff', lcolor(black) lwidth(medium)), scheme(s1color) title("`pname' 60-Day Rolling β", size(medium)) subtitle("Shaded: VIX top decile", size(small)) xtitle("Date", size(small)) ytitle("β₆₀", size(small)) xlabel(, format(%tdCY) angle(45) labsize(vsmall)) ylabel(, grid labsize(vsmall)) yline(1, lpattern(dash) lcolor(red)) legend(off) graphregion(color(white)) plotregion(margin(5 5 5 5)) aspectratio(0.6) name(rolling60_vix_`c', replace)

    local ++i
}

graph combine rolling60_vix_wti rolling60_vix_brent rolling60_vix_natgas rolling60_vix_corn rolling60_vix_wheat rolling60_vix_soybean, cols(3) xcommon ycommon imargin(zero) title("60-Day Rolling β — VIX Top Decile") subtitle("Shaded: VIX ≥ 90th percentile") name(rolling60_vix_all, replace)

/// GARCH
use vix_all_frequencies.dta, clear
local assets r_wti r_brent r_natgas_d r_corn_d r_wheat_d r_soybean_d

tempname garch_handle
postfile `garch_handle' str20 asset double ll double aic double bic using garch_ic.dta, replace

foreach a of local assets {
    display as text "Estimating Gaussian GARCH(1,1) for `a'"
    arch `a', arch(1) garch(1) distribution(normal) nocons
    local ll = e(ll)          
    local k  = e(df_m)        
    local n  = e(N)           
    local aic = `=-2*`ll' + 2*`k''
    local bic = `=-2*`ll' + ln(`n')*`k''
    post `handle' ("`a'") (`ll') (`aic') (`bic')
    display as text ""
}
postclose `garch_handle'

//HVAR 
local grains r_corn_d r_wheat_d r_soybean_d
matrix results = J(3,6,.)
local i = 1
foreach a of local grains {
    display as text "Running HAR‐RV regression for `a'  ..."
    gen rv_`a' = `a'^2
    rangestat (mean) rv_w=rv_`a', interval(date -4 0)
    rangestat (mean) rv_m=rv_`a', interval(date -22 0)
    drop if missing(L.rv_`a') | missing(rv_w) | missing(rv_m)
    quietly regress rv_`a' L.rv_`a' rv_w rv_m
    matrix results[`i',1] = _b[L.rv_`a']
    matrix results[`i',2] = _se[L.rv_`a']
    matrix results[`i',3] = _b[rv_w]
    matrix results[`i',4] = _se[rv_w]
    matrix results[`i',5] = _b[rv_m]
    matrix results[`i',6] = _se[rv_m]
    local ++i
    drop rv_`a' rv_w rv_m
} 

//Graphing
local vars r_corn_d r_wheat_d r_soybean_d
local cols navy forest_red maroon

set scheme journal

local i = 1
foreach x of local vars {
    local col : word `i' of `cols'

    tsline `x', scheme(journal) name(g_`x', replace) title("Time Series of `x'", size(medium) color(black)) xtitle("Date", size(small) color(black)) ytitle("Return (%)", size(small) color(black)) ylabel(, labsize(vsmall) angle(horizontal) grid) xlabel(, labsize(vsmall) format(%tdCY) angle(45) grid) lcolor(`col') lwidth(medium) legend(off) graphregion(color(white)) bgcolor(white)

    graph save "graph_`x'.gph", replace
    graph export "tsplot_`x'.png", name(g_`x') replace

    su `x'
    sktest `x'
    local ++i
}

//Durbin-Watson
tempname dwstats
postfile `dwstats' str12 series double d using dwstats.dta, replace

foreach x in r_sp r_brent r_wti r_natgas r_corn r_wheat r_soybean {
    quietly regress `x'
    quietly estat dwatson           
    local d = r(dw)                
    post `dwstats' ("`x'") (`d')
}

postclose `dwstats'
use dwstats.dta, clear

label var series “Return series”
label var d      “Durbin–Watson d”
list, noobs clean

/// Hedge Ratio

ssc install rangestat, replace
use vix_all_frequencies.dta, clear
tsset date
tempfile f_hwti f_hsoy f_hwheat f_hcorn f_hnat f_hbre

// WTI
preserve
    gen sp_wti        = r_sp * r_wti
    gen wti2          = r_wti^2
    rangestat (sum) r_sp r_wti sp_wti wti2 (count) r_sp, interval(date -59 0)
    rename r_sp_sum    sum_sp
    rename r_wti_sum   sum_wti
    rename sp_wti_sum  sum_spwti
    rename wti2_sum    sum_sq_wti
    rename r_sp_count  n_obs
    gen m_sp        = sum_sp    / n_obs
    gen m_wti       = sum_wti   / n_obs
    gen m_spwti     = sum_spwti / n_obs
    gen m_wti2      = sum_sq_wti/ n_obs
    gen cov_sp_wti  = m_spwti - m_sp*m_wti
    gen var_wti     = m_wti2   - m_wti*m_wti
    gen hedge_wti60 = cov_sp_wti / var_wti
    keep date hedge_wti60
    save `f_hwti', replace
restore

// Soybean
preserve
    gen sp_soybean_d      = r_sp * r_soybean_d
    gen soybean_d2        = r_soybean_d^2
    rangestat (sum) r_sp r_soybean_d sp_soybean_d soybean_d2 (count) r_sp, interval(date -59 0)
    rename r_sp_sum            sum_sp
    rename r_soybean_d_sum     sum_soybean_d
    rename sp_soybean_d_sum    sum_sopsy
    rename soybean_d2_sum      sum_sq_soy
    rename r_sp_count          n_obs
    gen m_sp              = sum_sp        / n_obs
    gen m_soybean_d       = sum_soybean_d / n_obs
    gen m_sopsy           = sum_sopsy     / n_obs
    gen m_soy2            = sum_sq_soy    / n_obs
    gen cov_sp_soybean_d  = m_sopsy - m_sp*m_soybean_d
    gen var_soybean_d     = m_soy2  - m_soybean_d*m_soybean_d
    gen hedge_soybean_d60 = cov_sp_soybean_d / var_soybean_d
    keep date hedge_soybean_d60
    save `f_hsoy', replace
restore

// Wheat
preserve
    gen sp_wheat_d     = r_sp * r_wheat_d
    gen wheat_d2       = r_wheat_d^2
    rangestat (sum) r_sp r_wheat_d sp_wheat_d wheat_d2 (count) r_sp, interval(date -59 0)
    rename r_sp_sum        sum_sp
    rename r_wheat_d_sum   sum_wheat_d
    rename sp_wheat_d_sum  sum_spwheat
    rename wheat_d2_sum    sum_sq_wheat
    rename r_sp_count      n_obs
    gen m_sp            = sum_sp       / n_obs
    gen m_wheat_d       = sum_wheat_d  / n_obs
    gen m_spwheat       = sum_spwheat  / n_obs
    gen m_wheat2        = sum_sq_wheat / n_obs
    gen cov_sp_wheat_d  = m_spwheat - m_sp*m_wheat_d
    gen var_wheat_d     = m_wheat2  - m_wheat_d*m_wheat_d
    gen hedge_wheat_d60 = cov_sp_wheat_d / var_wheat_d
    keep date hedge_wheat_d60
    save `f_hwheat', replace
restore

// Corn
preserve
    gen sp_corn_d      = r_sp * r_corn_d
    gen corn_d2        = r_corn_d^2
    rangestat (sum) r_sp r_corn_d sp_corn_d corn_d2 (count) r_sp, interval(date -59 0)
    rename r_sp_sum       sum_sp
    rename r_corn_d_sum   sum_corn_d
    rename sp_corn_d_sum  sum_spcorn
    rename corn_d2_sum    sum_sq_corn
    rename r_sp_count     n_obs
    gen m_sp           = sum_sp      / n_obs
    gen m_corn_d       = sum_corn_d  / n_obs
    gen m_spcorn       = sum_spcorn  / n_obs
    gen m_corn2        = sum_sq_corn / n_obs
    gen cov_sp_corn_d  = m_spcorn - m_sp*m_corn_d
    gen var_corn_d     = m_corn2  - m_corn_d*m_corn_d
    gen hedge_corn_d60 = cov_sp_corn_d / var_corn_d
    keep date hedge_corn_d60
    save `f_hcorn', replace
restore

// NatGas
preserve
    gen sp_natgas_d    = r_sp * r_natgas_d
    gen natgas_d2      = r_natgas_d^2
    rangestat (sum) r_sp r_natgas_d sp_natgas_d natgas_d2 (count) r_sp, interval(date -59 0)
    rename r_sp_sum        sum_sp
    rename r_natgas_d_sum  sum_natgas_d
    rename sp_natgas_d_sum sum_spnat
    rename natgas_d2_sum   sum_sq_nat
    rename r_sp_count      n_obs
    gen m_sp            = sum_sp       / n_obs
    gen m_natgas_d      = sum_natgas_d / n_obs
    gen m_spnat         = sum_spnat    / n_obs
    gen m_natgas2       = sum_sq_nat   / n_obs
    gen cov_sp_natgas_d = m_spnat - m_sp*m_natgas_d
    gen var_natgas_d    = m_natgas2 - m_natgas_d*m_natgas_d
    gen hedge_natgas_d60 = cov_sp_natgas_d / var_natgas_d
    keep date hedge_natgas_d60
    save `f_hnat', replace
restore

// Brent
preserve
    gen sp_brent       = r_sp * r_brent
    gen brent2         = r_brent^2
    rangestat (sum) r_sp r_brent sp_brent brent2 (count) r_sp, interval(date -59 0)
    rename r_sp_sum       sum_sp
    rename r_brent_sum    sum_brent
    rename sp_brent_sum   sum_spbre
    rename brent2_sum     sum_sq_bre
    rename r_sp_count     n_obs
    gen m_sp            = sum_sp       / n_obs
    gen m_brent         = sum_brent    / n_obs
    gen m_spbre         = sum_spbre    / n_obs
    gen m_bre2          = sum_sq_bre   / n_obs
    gen cov_sp_brent    = m_spbre - m_sp*m_brent
    gen var_brent       = m_bre2  - m_brent*m_brent
    gen hedge_brent60   = cov_sp_brent / var_brent
    keep date hedge_brent60
    save `f_hbre', replace
restore

use vix_all_frequencies.dta, clear
tsset date

merge 1:1 date using `f_hwti'
drop _merge
merge 1:1 date using `f_hsoy'
drop _merge
merge 1:1 date using `f_hwheat'
drop _merge
merge 1:1 date using `f_hcorn'
drop _merge
merge 1:1 date using `f_hnat'
drop _merge
merge 1:1 date using `f_hbre'
drop _merge

list date r_sp r_brent hedge_brent60 in 200/205, clean noobs

//Graphing
gen hedge_brent60_trunc     = cond(hedge_brent60     > 3, 3, cond(hedge_brent60     < -3, -3, hedge_brent60))
gen hedge_wti60_trunc       = cond(hedge_wti60       > 3, 3, cond(hedge_wti60       < -3, -3, hedge_wti60))
gen hedge_natgas_d60_trunc  = cond(date >= td(01jan1997), cond(hedge_natgas_d60 > 3, 3, cond(hedge_natgas_d60 < -3, -3, hedge_natgas_d60)), .)
gen hedge_corn_d60_trunc    = cond(hedge_corn_d60    > 3, 3, cond(hedge_corn_d60    < -3, -3, hedge_corn_d60))
gen hedge_soybean_d60_trunc = cond(hedge_soybean_d60 > 3, 3, cond(hedge_soybean_d60 < -3, -3, hedge_soybean_d60))
gen hedge_wheat_d60_trunc   = cond(hedge_wheat_d60   > 3, 3, cond(hedge_wheat_d60   < -3, -3, hedge_wheat_d60))

twoway (line hedge_brent60_trunc date, lcolor(blue) lwidth(medium)) (line hedge_wti60_trunc date, lcolor(red) lwidth(medium)) (line hedge_natgas_d60_trunc date, lcolor(green) lwidth(medium)), title("60-Day Rolling Hedge Ratios: Oil & Gas", size(medsmall)) subtitle("1990–2024", size(vsmall) color(gs8)) ytitle("Hedge Ratio", size(small)) xtitle("Date", size(small)) xlabel(, format(%tdCY) labsize(vsmall) angle(45) grid) ylabel(-3(1)3, labsize(vsmall) grid) yscale(range(-3 3) noextend) legend(order(1 "Brent" 2 "WTI" 3 "NatGas") size(vsmall) cols(1) ring(0) pos(1)) yline(0, lcolor(gs12) lpattern(dash)) graphregion(color(white) lcolor(black) lwidth(thin)) plotregion(margin(5 5 5 5)) bgcolor(white) scheme(s1color) name(hedge_ratio_overlay_oilgas_t3, replace)
graph save hedge_ratio_overlay_oilgas_t3.gph, replace
graph export hedge_ratio_overlay_oilgas_t3.png, replace width(1800)

twoway (line hedge_corn_d60_trunc date, lcolor(black) lwidth(medium)) (line hedge_soybean_d60_trunc date, lcolor(dkorange) lwidth(medium)) (line hedge_wheat_d60_trunc date, lcolor(maroon) lwidth(medium)), title("60-Day Rolling Hedge Ratios: Grains", size(medsmall)) subtitle("1990–2024", size(vsmall) color(gs8)) ytitle("Hedge Ratio", size(small)) xtitle("Date", size(small)) xlabel(, format(%tdCY) labsize(vsmall) angle(45) grid) ylabel(-3(1)3, labsize(vsmall) grid) yscale(range(-3 3) noextend) legend(order(1 "Corn" 2 "Soybean" 3 "Wheat") size(vsmall) cols(1) ring(0) pos(1)) yline(0, lcolor(gs12) lpattern(dash)) graphregion(color(white) lcolor(black) lwidth(thin)) plotregion(margin(5 5 5 5)) bgcolor(white) scheme(s1color) name(hedge_ratio_overlay_grains_t3, replace)
graph save hedge_ratio_overlay_grains_t3.gph, replace
graph export hedge_ratio_overlay_grains_t3.png, replace width(1800)

gen hedge_corn_d60_t10    = cond(hedge_corn_d60 > 10, 10, cond(hedge_corn_d60 < -10, -10, hedge_corn_d60))
gen hedge_soybean_d60_t10 = cond(hedge_soybean_d60 > 10, 10, cond(hedge_soybean_d60 < -10, -10, hedge_soybean_d60))
gen hedge_wheat_d60_t10   = cond(hedge_wheat_d60 > 10, 10, cond(hedge_wheat_d60 < -10, -10, hedge_wheat_d60))

twoway (line hedge_corn_d60_t10 date, lcolor(black) lwidth(medium)), title("60-Day Hedge Ratio (±10): Corn", size(medsmall)) subtitle("1990–2024", size(vsmall) color(gs8)) ytitle("Hedge Ratio", size(small)) xtitle("Date", size(small)) xlabel(, format(%tdCY) labsize(vsmall) angle(45) grid) ylabel(-10(5)10, labsize(vsmall) grid) yline(0, lcolor(gs12) lpattern(dash)) legend(off) graphregion(color(white) lcolor(black) lwidth(thin)) plotregion(margin(5 5 5 5)) bgcolor(white) scheme(s1color) name(hedge_ratio_corn_t10, replace)
graph save hedge_ratio_corn_t10.gph, replace
graph export hedge_ratio_corn_t10.png, replace width(1800)

twoway (line hedge_soybean_d60_t10 date, lcolor(dkorange) lwidth(medium)), title("60-Day Hedge Ratio (±10): Soybean", size(medsmall)) subtitle("1990–2024", size(vsmall) color(gs8)) ytitle("Hedge Ratio", size(small)) xtitle("Date", size(small)) xlabel(, format(%tdCY) labsize(vsmall) angle(45) grid) ylabel(-10(5)10, labsize(vsmall) grid) yline(0, lcolor(gs12) lpattern(dash)) legend(off) graphregion(color(white) lcolor(black) lwidth(thin)) plotregion(margin(5 5 5 5)) bgcolor(white) scheme(s1color) name(hedge_ratio_soybean_t10, replace)
graph save hedge_ratio_soybean_t10.gph, replace
graph export hedge_ratio_soybean_t10.png, replace width(1800)

twoway (line hedge_wheat_d60_t10 date, lcolor(maroon) lwidth(medium)), title("60-Day Hedge Ratio (±10): Wheat", size(medsmall)) subtitle("1990–2024", size(vsmall) color(gs8)) ytitle("Hedge Ratio", size(small)) xtitle("Date", size(small)) xlabel(, format(%tdCY) labsize(vsmall) angle(45) grid) ylabel(-10(5)10, labsize(vsmall) grid) yline(0, lcolor(gs12) lpattern(dash)) legend(off) graphregion(color(white) lcolor(black) lwidth(thin)) plotregion(margin(5 5 5 5)) bgcolor(white) scheme(s1color) name(hedge_ratio_wheat_t10, replace)
graph save hedge_ratio_wheat_t10.gph, replace
graph export hedge_ratio_wheat_t10.png, replace width(1800)

