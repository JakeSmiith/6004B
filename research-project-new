// Set working directory to where your Excel file lives.
cd "C:\Users\jakes\Downloads"
// Declare three temporary filenames (`daily`, `mon`, `quart`) for intermediate saves.
tempfile daily mon quart
// Import the “Daily” sheet from the Excel file, using the first row as variable names and clearing any data in memory.
import excel using "VIX_historical.xlsx", sheet("Daily") firstrow clear
// Create a new variable `date` by copying the raw `observation_date`.
gen date = observation_date
// Format `date` as MM/DD/YYYY for readability.
format date %tdNN/DD/CCYY
// Generate a string variable `freq` tagging every observation as “daily.”
gen freq = "daily"
// Drop the original unformatted `observation_date` variable to avoid duplication.
drop observation_date
// Rename the VIX closing series from `VIXCLS` to `vix`.
rename VIXCLS vix
// Rename the 10-Year minus 2-Year Treasury spread from `T10Y2Y` to `t10y2y`.
rename T10Y2Y t10y2y
// Rename the 10-Year implied equity volatility from `T10YIE` to `t10yie`.
rename T10YIE t10yie
// Rename WTI oil price from `WTI` to `wti`.
rename WTI wti
// Rename Brent oil price from `BC` to `brent`.
rename BC brent
// Declare the dataset as a daily time series keyed by `date`.
tsset date, daily
// Save this processed daily dataset to the temporary file `daily`, overwriting if it exists.
save `daily', replace
// List the first 15 observations of `date` and `brent` to verify import went correctly.
list date brent in 1/15
// Re-save the daily dataset (no changes since last save, but ensures persistence).
save `daily', replace
// Import the “Monthly” sheet from the same Excel file, clearing out the existing data.
import excel using "VIX_historical.xlsx", sheet("Monthly") firstrow clear
// Rename the raw `observation_date` to `date` for consistency.
rename observation_date date
// List the first 15 observations of `date` and `WHEAT` to check the import.
list date WHEAT in 1/15
// Rename the 3-month Treasury bill rate from `TB3S` to `tbill3m`.
rename TB3S tbill3m
// Rename the Henry Hub natural gas price from `HHNG` to `natgas`.
rename HHNG natgas
// Rename the corn price series from `CORN` to `corn`.
rename CORN corn
// Rename the wheat price series from `WHEAT` to `wheat`.
rename WHEAT wheat
// Rename the soybean price series from `SOYBEAN` to `soybean`.
rename SOYBEAN soybean
// (If not already done) copy `observation_date` again into `date` for formatting.
gen date = observation_date
// Format `date` as MM/DD/YYYY.
format date %tdNN/DD/CCYY
// Declare this dataset as a daily time series so we can fill in gaps.
tsset date, daily
// Fill in all missing calendar days between the first and last dates.
tsfill
// Linearly interpolate the `tbill3m` series to daily frequency, storing in `tb3m_d`.
ipolate tbill3m date, gen(tb3m_d)
// Interpolate the `natgas` series to daily, storing in `natgas_d`.
ipolate natgas date, gen(natgas_d)
// Interpolate the `corn` series to daily, storing in `corn_d`.
ipolate corn date, gen(corn_d)
// Interpolate the `wheat` series to daily, storing in `wheat_d`.
ipolate wheat date, gen(wheat_d)
// Interpolate the `soybean` series to daily, storing in `soybean_d`.
ipolate soybean date, gen(soybean_d)
// List interpolated values for Jan 1–15, 1990, to confirm the interpolation worked.
list date tb3m_d natgas_d corn_d wheat_d soybean_d if inrange(date, td(01jan1990), td(15jan1990)), clean noobs
// Save the final interpolated dataset to the temporary file `mon`, overwriting if necessary.
save `mon', replace

// Import the “Quarterly” sheet from the Excel file, using the first row as variable names and clearing any existing data.
import excel using "VIX_historical.xlsx", sheet("Quarterly") firstrow clear
// Create a new variable `date` by copying the raw `observation_date`.
gen date = observation_date
// Format `date` as MM/DD/YYYY for readability.
format date %tdNN/DD/CCYY
// Declare this dataset as a daily time series so we can fill in gaps.
tsset date, daily
// Fill in all missing calendar days between the first and last dates.
tsfill
// Linearly interpolate the quarterly `gdp` series to daily frequency, storing in `gdp_d`.
ipolate gdp date, gen(gdp_d)
// List `date`, original `gdp`, and interpolated `gdp_d` for Jan 1–15, 1990, to confirm interpolation.
list date gdp gdp_d if inrange(date, td(01jan1990), td(15jan1990)), clean noobs
// Save the interpolated quarterly dataset to the temporary file `quart`, overwriting if necessary.
save `quart', replace
// Clear the current data from memory.
clear
// Load the daily dataset saved earlier.
use `daily'
// Merge in the interpolated monthly data, one‐to‐one on `date`.
merge 1:1 date using "`mon'"
// Drop the merge indicator `_merge` (all matched by design).
drop _merge
// Merge in the interpolated quarterly data, one‐to‐one on `date`.
merge 1:1 date using "`quart'"
// Save the combined all‐frequencies dataset to disk.
save vix_all_frequencies.dta, replace
// List the first 15 observations of `date`, `gdp_d`, and `wheat_d` to verify the final merge.
list date gdp_d wheat_d in 1/15
// Reload the combined dataset.
use vix_all_frequencies.dta, clear
// Convert the string `freq` into a numeric `panel` identifier.
encode freq, gen(panel)
// Declare the data as a panel with `panel` units and time variable `date`.
xtset panel date
// Describe the panel structure (number of panels, time spans, gaps).
xtdescribe
// Create 10 equally-sized groups (deciles) of the VIX distribution.
xtile decile = vix, nq(10)
// Generate a binary flag `crisis10` for observations in the top (10th) decile of VIX.
gen crisis10 = decile == 10
// Define value labels for `crisis10`: 0 = "Normal", 1 = "Crisis".
label define cris_lbl2 0 "Normal" 1 "Crisis"
label values crisis10 cris_lbl2
// Silently compute detailed summary statistics for `vix`, storing the 90th percentile.
quietly sum vix, detail
local p90 = r(p90)
// Plot a histogram of VIX (50 bins), overlay a normal curve, and draw a red dashed line at the 90th-percentile cutoff.
histogram vix, bin(50) normal xline(`p90', lcolor(red) lpattern(dash)) title("VIX Distribution with Top-Decile Cutoff") xtitle("VIX Level") ytitle("Frequency") note("Red line marks the minimum VIX value in the top decile (`=string(`p90',\"%9.2f\")')")
// Save the fully processed dataset, including deciles and crisis flag.
save vix_all_frequencies.dta, replace

// Import the S&P 500 CSV file, using the first row for variable names and clearing any existing data.
import delimited "C:\Users\jakes\Downloads\sp500.csv", varnames(1) clear
// Rename the imported date string variable to date_str.
rename date date_str
// Create a proper Stata date variable by parsing date_str in DMY format.
gen date = date(date_str, "DMY")
// Format the new date variable as MM/DD/YYYY.
format date %tdNN/DD/CCYY
// Display the first 15 observations of date_str and adjusted_close to verify import.
list date_str adjusted_close in 1/15
// Drop the original date_str now that we have a proper date.
drop date_str
// Keep only the date and adjusted_close variables.
keep date adjusted_close
// Rename adjusted_close to sp_adjclose for clarity.
rename adjusted_close sp_adjclose
// Save this dataset of S&P 500 adjusted closes to disk.
save "sp_returns.dta", replace
// Load the combined VIX/frequencies data.
use vix_all_frequencies.dta, clear
// Remove any leftover merge indicator.
drop _merge
// Merge in the full S&P 500 series one‐to‐one on date.
merge 1:1 date using sp_full.dta
// Drop the merge indicator again.
drop _merge
// Declare the merged data as a daily time series by date.
tsset date, daily
// Drop any days where Brent is missing to ensure balanced data.
drop if missing(brent)
// List the first 15 observations of brent, soybean_d, gdp_d, and date to confirm the merge.
list brent soybean_d gdp_d date in 1/15
// Sort observations by date for time‐series calculations.
sort date
// Compute the log of the S&P 500 adjusted close.
gen ln_sp500 = log(sp_adjclose)
// Compute the daily S&P 500 return in percentage points.
gen r_sp = 100*(ln_sp500 - ln_sp500[_n-1])
// List the first 15 observations of date, sp_adjclose, ln_sp500, and r_sp (no obs #).
list date sp_adjclose ln_sp500 r_sp in 1/15, clean noobs
// Save the updated VIX/frequencies dataset with market returns included.
save vix_all_frequencies.dta, replace
// Sort by date again before computing logs of commodity series.
sort date
// Generate logs of daily interpolated commodity and oil series.
gen log_natgas_d = ln(natgas_d)
gen log_corn_d   = ln(corn_d)
gen log_wheat_d  = ln(wheat_d)
gen log_soybean_d= ln(soybean_d)
gen log_brent    = ln(brent)
gene log_wti     = ln(wti)      // matches original 'gene' command; typically 'gen'
// Flag any non‐positive values before logging (to catch errors).
generate byte bad_log = (natgas_d<=0 | corn_d<=0 | wheat_d<=0 | soybean_d<=0 | brent<=0 | wti<=0)
// List dates where bad_log is true to inspect problematic data points.
list date if bad_log
// Preview the first 15 logged values of corn, soybean, and WTI.
l/ist log_corn_d log_soybean_d log_wti date in 1/15
/ Sort by date before computing daily commodity returns.
sort date
// Compute daily returns (% change) for each logged series.
gen r_natgas_d   = 100*(log_natgas_d   - log_natgas_d[_n-1])
gen r_corn_d     = 100*(log_corn_d     - log_corn_d[_n-1])
gen r_wheat_d    = 100*(log_wheat_d    - log_wheat_d[_n-1])
gen r_soybean_d  = 100*(log_soybean_d  - log_soybean_d[_n-1])
gen r_brent      = 100*(log_brent      - log_brent[_n-1])
gen r_wti        = 100*(log_wti        - log_wti[_n-1])
// Drop the first observation (no prior day to compute returns).
drop if _n==1
// Install the estout package (for table export) if not already installed.
ssc install estout, replace
// Clear any previously stored estimation results.
eststo clear
// Change directory to where you want to save regression output.
cd "C:\stata_output"
// Run a robust regression of Brent returns on market returns and store it.
reg r_brent r_sp, robust
eststo r_brent
// Loop over each asset, regress its returns on market returns, and store results.
foreach a in wti natgas corn wheat soybean {
    reg r_`a' r_sp, robust
    eststo r_`a'
}
// Export all stored regression tables to an RTF file in one command.
esttab r_brent r_wti r_natgas r_corn r_wheat r_soybean using market_regressions.rtf, replace se star(* 0.10 ** 0.05 *** 0.01) label b(3) se(3) title("Baseline Regressions: Asset Returns on Market Return") mtitles("Brent" "WTI" "Natural Gas" "Corn" "Wheat" "Soybean") coeflabels(r_sp "Market Return") keep(r_sp) compress nonumbers addnotes("Robust standard errors in parentheses." "Significance: * p<0.10; ** p<0.05; *** p<0.01")
// Import the S&P 500 CSV, using the first row as variable names and clearing any existing data  
import delimited "C:\Users\jakes\Downloads\sp500.csv", varnames(1) clear
// Rename the raw date string to date_str  
rename date date_str
// Parse date_str (DMY) into a Stata date variable called date  
gen date = date(date_str, "DMY")
// Format date as MM/DD/YYYY for readability  
format date %tdNN/DD/CCYY
// Preview the first 15 observations of date_str and adjusted_close  
list date_str adjusted_close in 1/15
// Drop the original date_str now that date is set  
drop date_str
// Keep only date and adjusted_close in the dataset  
keep date adjusted_close
// Rename adjusted_close to sp_adjclose for clarity  
rename adjusted_close sp_adjclose
// Save the S&P 500 series to “sp_returns.dta”  
save "sp_returns.dta", replace
// Load the combined VIX & frequency dataset  
use vix_all_frequencies.dta, clear
// Ensure no leftover merge indicators  
drop _merge
// Merge in the full S&P 500 returns one-to-one on date  
merge 1:1 date using sp_full.dta
// Drop the merge indicator from this merge  
drop _merge
// Declare the merged data as a daily time series by date  
tsset date, daily
// Drop any days with missing Brent prices to balance the panel  
drop if missing(brent)
// Preview the first 15 observations of brent, soybean_d, gdp_d, and date  
list brent soybean_d gdp_d date in 1/15
// Sort by date for time-series calculations  
sort date
// Compute ln(sp_adjclose) as ln_sp500  
gen ln_sp500 = log(sp_adjclose)
// Compute the daily S&P 500 return r_sp = 100·Δln_sp500  
gen r_sp = 100*(ln_sp500 - ln_sp500[_n-1])
// Preview date, sp_adjclose, ln_sp500, and r_sp for the first 15 obs  
list date sp_adjclose ln_sp500 r_sp in 1/15, clean noobs
// Save the updated VIX dataset with market returns included  
save vix_all_frequencies.dta, replace
// Sort by date before logging commodities  
sort date
// Generate log of each interpolated commodity series  
gen log_natgas_d   = ln(natgas_d)
gen log_corn_d     = ln(corn_d)
gen log_wheat_d    = ln(wheat_d)
gen log_soybean_d  = ln(soybean_d)
gen log_brent      = ln(brent)
gen log_wti        = ln(wti)
// Flag any non-positive values to catch log errors  
gen byte bad_log = (natgas_d<=0 | corn_d<=0 | wheat_d<=0 | soybean_d<=0 | brent<=0 | wti<=0)
// List dates with bad_log == 1  
list date if bad_log
// Preview the first 15 logged values of corn, soybean, and WTI  
list log_corn_d log_soybean_d log_wti date in 1/15
// Sort by date before computing daily returns  
sort date
// Compute daily % returns for each logged series  
gen r_natgas_d   = 100*(log_natgas_d   - log_natgas_d[_n-1])
gen r_corn_d     = 100*(log_corn_d     - log_corn_d[_n-1])
gen r_wheat_d    = 100*(log_wheat_d    - log_wheat_d[_n-1])
gen r_soybean_d  = 100*(log_soybean_d  - log_soybean_d[_n-1])
gen r_brent      = 100*(log_brent      - log_brent[_n-1])
gen r_wti        = 100*(log_wti        - log_wti[_n-1])
// Drop the first observation since returns cannot be computed for it  
drop if _n==1
// Install estout for table exports (if not already installed)  
ssc install estout, replace
// Clear any previously stored estimation sets  
eststo clear
// Change directory to your Stata output folder  
cd "C:\stata_output"
// Regress Brent returns on market return with robust SEs and store results  
reg r_brent c.r_sp##i.crisis10, robust
eststo r_brent
// Define the list of assets for looping  
local assets natgas_d corn_d wheat_d soybean_d brent wti
// Loop through each asset, regress its return on market × crisis interaction, and store  
foreach a of local assets {
    reg r_`a' c.r_sp##i.crisis10, robust
    eststo `a'
}
// Export all interaction regression tables in one RTF with custom titles & labels  
esttab natgas_d corn_d wheat_d soybean_d brent wti using crisis_interaction_regressions.rtf, replace se star(* 0.10 ** 0.05 *** 0.01) label b(3) se(3) ///
    title("Interaction Regressions: Asset Returns × VIX Top-Decile Crisis") ///
    mtitles("NatGas" "Corn" "Wheat" "Soybean" "Brent" "WTI") ///
    coeflabels(1.r_sp "Market (Normal)" 1.crisis10 "Crisis" r_sp#1.crisis10 "Market × Crisis") ///
    compress nonumbers addnotes("Robust standard errors in parentheses." "Significance: * p<0.10; ** p<0.05; *** p<0.01")
// Generate crisis indicators for GFC and COVID-19 windows  
gen crisisGFC   = inrange(date, td(15sep2008), td(9mar2009))
gen crisisCOVID = inrange(date, td(20feb2020), td(30apr2020))
// Label the crisis indicator variables  
label var crisisGFC   "GFC: 15Sep2008–09Mar2009"
label var crisisCOVID "COVID-19: 20Feb2020–30Apr2020"
// Display header and run Brent × market × GFC interaction  
di as txt "=== Brent vs S&P during GFC ==="  
reg  r_brent c.r_sp##i.crisisGFC, robust  
di as txt ""
// Display header and run Brent × market × COVID interaction  
di as txt "=== Brent vs S&P during COVID-19 ==="  
reg  r_brent c.r_sp##i.crisisCOVID, robust  
di as txt ""
// Loop assets and periods to run each interaction subsample regression  
foreach a in brent wti natgas corn wheat soybean {
    foreach per in GFC COVID {
        di as txt "=== `a': `per' window ==="
        reg r_`a' c.r_sp##i.crisis`per', robust
        di as txt ""
    }
}
// Save the full dataset with all flags & interactions  
save vix_all_frequencies.dta, replace
// Install rangestat for rolling/window stats  
ssc install rangestat, replace
// Reload the full dataset and declare ts  
use vix_all_frequencies.dta, clear  
tsset date
// Create tempfiles for each asset’s windowed stats  
tempfile f_wti f_brent f_nat f_corn f_wheat f_soy
// Compute observation numbers to identify GFC and COVID windows  
sort date  
gen obs_no = _n  
list date obs_no if date==td(15sep2008)|date==td(9mar2009), clean noobs  
list date obs_no if date==td(20feb2020)|date==td(30apr2020), clean noobs
// Run GFC subsample regressions by obs_no 4754–4874 and store  
reg r_brent r_sp in 4754/4874, robust  
eststo r_brent  
foreach a in wti natgas corn wheat soybean {
    reg r_`a' r_sp in 4754/4874, robust
    eststo r_`a'
}
esttab r_brent r_wti r_natgas r_corn r_wheat r_soybean using gfc_subsample_regressions.rtf, replace se star(* 0.10 ** 0.05 *** 0.01) label b(3) se(3) title("GFC Subsample Regressions: Asset Returns on Market Return (Sep 2008–Mar 2009)") mtitles("Brent" "WTI" "Natural Gas" "Corn" "Wheat" "Soybean") coeflabels(r_sp "Market Return") keep(r_sp) compress nonumbers addnotes("Sample: Obs 4754–4874 (GFC Window)", "Robust standard errors in parentheses.", "Significance: * p<0.10; ** p<0.05; *** p<0.01")

// Run COVID subsample regressions by obs_no 7647–7695 and store  
reg r_brent r_sp in 7647/7695, robust  
eststo r_brent  
foreach a in wti natgas corn wheat soybean {
    reg r_`a' r_sp in 7647/7695, robust
    eststo r_`a'
}
esttab r_brent r_wti r_natgas r_corn r_wheat r_soybean using covid_subsample_regressions.rtf, replace se star(* 0.10 ** 0.05 *** 0.01) label b(3) se(3) title("COVID Subsample Regressions: Asset Returns on Market Return (Feb – Apr 2020)") mtitles("Brent" "WTI" "Natural Gas" "Corn" "Wheat" "Soybean") coeflabels(r_sp "Market Return") keep(r_sp) compress nonumbers addnotes("Sample: Obs 7647–7695 (COVID Window)", "Robust standard errors in parentheses.", "Significance: * p<0.10; ** p<0.05; *** p<0.01")

// Create combined crisis sample flag for GFC + COVID windows  
gen combined_crisis_sample = inrange(_n,4754,4874) | inrange(_n,7647,7695)

// Run combined crisis subsample regressions and store  
reg r_brent r_sp if combined_crisis_sample==1, robust  
eststo r_brent  
foreach a in wti natgas corn wheat soybean {
    reg r_`a' r_sp if combined_crisis_sample==1, robust
    eststo r_`a'
}
esttab r_brent r_wti r_natgas r_corn r_wheat r_soybean using crisis_sample_subsample_regressions.rtf, replace se star(* 0.10 ** 0.05 *** 0.01) label b(3) se(3) title("Crisis Subsample Regressions: Asset Returns on Market Return (GFC + COVID)") mtitles("Brent" "WTI" "Natural Gas" "Corn" "Wheat" "Soybean") coeflabels(r_sp "Market Return") keep(r_sp) compress nonumbers addnotes("Sample: Obs 4754–4874 (GFC) & 7647–7695 (COVID)", "Robust standard errors in parentheses.", "Significance: * p<0.10; ** p<0.05; *** p<0.01")

// Create output directory if it doesn’t exist and switch to it
mkdir "C:\stata_output"
cd "C:\stata_output"

// Start a new Word document for baseline regressions
putdocx clear
putdocx begin

// Insert bold heading for baseline regressions
putdocx paragraph
putdocx text ("Baseline Regressions: Asset Returns on Market Return"), bold

// Loop over each asset return series: regress on market return, then insert table
foreach a in r_natgas_d r_corn_d r_wheat_d r_soybean_d r_brent r_wti {
    // Run robust regression
    regress `a' r_sp, robust
    // Derive short name for table
    local shortname = substr("`a'",3,3)
    // Insert italic caption
    putdocx paragraph
    putdocx text ("Regression of `a' on Market Return"), italic
    // Insert and center regression table
    putdocx table tbl_`shortname' = etable
    putdocx table tbl_`shortname'(1,.), halign(center)
}

// Save the baseline regressions document
putdocx save "baseline_regressions.docx", replace

// Prepare new document for 90th‐percentile crisis interactions
mkdir "C:\stata_output"
cd "C:\stata_output"
putdocx clear
putdocx begin

// Insert bold heading for crisis interaction regressions
putdocx paragraph
putdocx text ("Crisis Regressions: Asset Returns on Market Return × VIX Top Decile"), bold

// Define assets and loop: regress on market×crisis10, then insert table
local assets natgas_d corn_d wheat_d soybean_d brent wti
foreach a of local assets {
    regress r_`a' c.r_sp##i.crisis10, robust
    local shortname = substr("`a'", 1, 3)
    putdocx paragraph
    putdocx text ("Regression of r_`a' on Market Return × Crisis10"), italic
    putdocx table tblc_`shortname' = etable
    putdocx table tblc_`shortname'(1,.), halign(center)
}

// Save the crisis interaction regressions document
putdocx save "crisis10_regressions.docx", replace

// Start new document for GFC subsample regressions
cd "C:\stata_output"
putdocx clear
putdocx begin

// Insert bold heading for GFC window
putdocx paragraph
putdocx text("GFC Subsample Regressions (15 Sep 2008 – 9 Mar 2009)"), bold

// Brent GFC regression & table
reg r_brent r_sp in 4754/4874, robust
putdocx paragraph
putdocx text("r_brent regressed on r_sp during GFC"), italic
putdocx table t1 = etable
putdocx table t1(1,.), halign(center)

// WTI GFC regression & table
reg r_wti r_sp in 4754/4874, robust
putdocx paragraph
putdocx text("r_wti regressed on r_sp during GFC"), italic
putdocx table t2 = etable
putdocx table t2(1,.), halign(center)

// NatGas GFC regression & table
reg r_natgas r_sp in 4754/4874, robust
putdocx paragraph
putdocx text("r_natgas regressed on r_sp during GFC"), italic
putdocx table t3 = etable
putdocx table t3(1,.), halign(center)

// Corn GFC regression & table
reg r_corn r_sp in 4754/4874, robust
putdocx paragraph
putdocx text("r_corn regressed on r_sp during GFC"), italic
putdocx table t4 = etable
putdocx table t4(1,.), halign(center)

// Wheat GFC regression & table
reg r_wheat r_sp in 4754/4874, robust
putdocx paragraph
putdocx text("r_wheat regressed on r_sp during GFC"), italic
putdocx table t5 = etable
putdocx table t5(1,.), halign(center)

// Soybean GFC regression & table
reg r_soybean r_sp in 4754/4874, robust
putdocx paragraph
putdocx text("r_soybean regressed on r_sp during GFC"), italic
putdocx table t6 = etable
putdocx table t6(1,.), halign(center)

// Save the GFC subsample regressions document
putdocx save "gfc_manual_regressions.docx", replace


// Clear any existing Word document content
putdocx clear
// Begin a new Word document for COVID‐19 subsample regressions
putdocx begin

// Brent: run robust regression of r_brent on r_sp for observations 7647–7695 (COVID window)
reg r_brent r_sp in 7647/7695, robust
// Insert paragraph and italic caption for the Brent COVID regression
putdocx paragraph
putdocx text("r_brent regressed on r_sp during COVID-19"), italic
// Insert and center the Brent regression table (t1)
putdocx table t1 = etable
putdocx table t1(1,.), halign(center)

// WTI: run robust regression of r_wti on r_sp for observations 7647–7695
reg r_wti r_sp in 7647/7695, robust
// Insert paragraph and italic caption for the WTI COVID regression
putdocx paragraph
putdocx text("r_wti regressed on r_sp during COVID-19"), italic
// Insert and center the WTI regression table (t2)
putdocx table t2 = etable
putdocx table t2(1,.), halign(center)

// NatGas: run robust regression of r_natgas on r_sp for observations 7647–7695
reg r_natgas r_sp in 7647/7695, robust
// Insert paragraph and italic caption for the NatGas COVID regression
putdocx paragraph
putdocx text("r_natgas regressed on r_sp during COVID-19"), italic
// Insert and center the NatGas regression table (t3)
putdocx table t3 = etable
putdocx table t3(1,.), halign(center)

// Corn: run robust regression of r_corn on r_sp for observations 7647–7695
reg r_corn r_sp in 7647/7695, robust
// Insert paragraph and italic caption for the Corn COVID regression
putdocx paragraph
putdocx text("r_corn regressed on r_sp during COVID-19"), italic
// Insert and center the Corn regression table (t4)
putdocx table t4 = etable
putdocx table t4(1,.), halign(center)

// Wheat: run robust regression of r_wheat on r_sp for observations 7647–7695
reg r_wheat r_sp in 7647/7695, robust
// Insert paragraph and italic caption for the Wheat COVID regression
putdocx paragraph
putdocx text("r_wheat regressed on r_sp during COVID-19"), italic
// Insert and center the Wheat regression table (t5)
putdocx table t5 = etable
putdocx table t5(1,.), halign(center)

// Soybean: run robust regression of r_soybean on r_sp for observations 7647–7695
reg r_soybean r_sp in 7647/7695, robust
// Insert paragraph and italic caption for the Soybean COVID regression
putdocx paragraph
putdocx text("r_soybean regressed on r_sp during COVID-19"), italic
// Insert and center the Soybean regression table (t6)
putdocx table t6 = etable
putdocx table t6(1,.), halign(center)
// Save the COVID‐19 subsample regression document, overwriting if necessary
putdocx save "covid_manual_regressions.docx", replace

// Rolling Betas: compute 60‐day rolling regression betas for each asset
// WTI: preserve current data, run rolling regression of r_wti on r_sp over the past 60 days (including today), keep date and coefficient, rename, save, then restore
preserve
rangestat (reg) r_wti    r_sp, interval(date -59 0)
keep date b_r_sp
rename b_r_sp beta60_r_wti
save `f_wti', replace
restore

// Brent: same for r_brent
preserve
rangestat (reg) r_brent r_sp, interval(date -59 0)
keep date b_r_sp
rename b_r_sp beta60_r_brent
save `f_brent', replace
restore

// NatGas: same for r_natgas
preserve
rangestat (reg) r_natgas r_sp, interval(date -59 0)
keep date b_r_sp
rename b_r_sp beta60_r_natgas
save `f_nat', replace
restore

// Corn: same for r_corn
preserve
rangestat (reg) r_corn  r_sp, interval(date -59 0)
keep date b_r_sp
rename b_r_sp beta60_r_corn
save `f_corn', replace
restore

// Wheat: same for r_wheat
preserve
rangestat (reg) r_wheat r_sp, interval(date -59 0)
keep date b_r_sp
rename b_r_sp beta60_r_wheat
save `f_wheat', replace
restore

// Soybean: same for r_soybean
preserve
rangestat (reg) r_soybean r_sp, interval(date -59 0)
keep date b_r_sp
rename b_r_sp beta60_r_soybean
save `f_soy', replace
restore

// Merge all rolling‐beta files one by one into the master dataset
merge 1:1 date using `f_wti'
drop _merge
merge 1:1 date using `f_brent'
drop _merge
merge 1:1 date using `f_nat'
drop _merge
merge 1:1 date using `f_corn'
drop _merge
merge 1:1 date using `f_wheat'
drop _merge
merge 1:1 date using `f_soy'
drop _merge
// List a sample of the new beta variables from observations 60 to 70 to verify
list date beta60_* in 60/70, clean noobs

// Declare tempfiles for 30‐day rolling beta outputs
tempfile f_wti30 f_brent30 f_nat30 f_corn30 f_wheat30 f_soy30

// Compute 30‐day rolling beta for WTI: preserve, run regression over past 30 days, keep, rename, save, then restore
preserve
  rangestat (reg) r_wti    r_sp, interval(date -29 0)
  keep date b_r_sp
  rename b_r_sp beta30_r_wti
  save `f_wti30', replace
restore

// Compute 30‐day rolling beta for Brent
preserve
  rangestat (reg) r_brent  r_sp, interval(date -29 0)
  keep date b_r_sp
  rename b_r_sp beta30_r_brent
  save `f_brent30', replace
restore

// Compute 30‐day rolling beta for NatGas
preserve
  rangestat (reg) r_natgas r_sp, interval(date -29 0)
  keep date b_r_sp
  rename b_r_sp beta30_r_natgas
  save `f_nat30', replace
restore

// Compute 30‐day rolling beta for Corn
preserve
  rangestat (reg) r_corn   r_sp, interval(date -29 0)
  keep date b_r_sp
  rename b_r_sp beta30_r_corn
  save `f_corn30', replace
restore

// Compute 30‐day rolling beta for Wheat
preserve
  rangestat (reg) r_wheat  r_sp, interval(date -29 0)
  keep date b_r_sp
  rename b_r_sp beta30_r_wheat
  save `f_wheat30', replace
restore

// Compute 30‐day rolling beta for Soybean
preserve
  rangestat (reg) r_soybean r_sp, interval(date -29 0)
  keep date b_r_sp
  rename b_r_sp beta30_r_soybean
  save `f_soy30', replace
restore

// Merge the 30‐day beta files back into the master dataset one by one
merge 1:1 date using `f_wti30'
drop _merge
merge 1:1 date using `f_brent30'
drop _merge
merge 1:1 date using `f_nat30'
drop _merge
merge 1:1 date using `f_corn30'
drop _merge
merge 1:1 date using `f_wheat30'
drop _merge
merge 1:1 date using `f_soy30'
drop _merge

// Declare tempfiles for 120‐day rolling beta outputs
tempfile f_wti120 f_brent120 f_nat120 f_corn120 f_wheat120 f_soy120

// WTI 120‐day rolling beta: preserve, run 120‐day regression, keep date & coefficient, rename, save, restore
preserve
  rangestat (reg) r_wti    r_sp, interval(date -119 0)
  keep date b_r_sp
  rename b_r_sp beta120_r_wti
  save `f_wti120', replace
restore

// Brent 120‐day rolling beta
preserve
  rangestat (reg) r_brent  r_sp, interval(date -119 0)
  keep date b_r_sp
  rename b_r_sp beta120_r_brent
  save `f_brent120', replace
restore

// NatGas 120‐day rolling beta
preserve
  rangestat (reg) r_natgas r_sp, interval(date -119 0)
  keep date b_r_sp
  rename b_r_sp beta120_r_natgas
  save `f_nat120', replace
restore

// Corn 120‐day rolling beta
preserve
  rangestat (reg) r_corn   r_sp, interval(date -119 0)
  keep date b_r_sp
  rename b_r_sp beta120_r_corn
  save `f_corn120', replace
restore

// Wheat 120‐day rolling beta
preserve
  rangestat (reg) r_wheat  r_sp, interval(date -119 0)
  keep date b_r_sp
  rename b_r_sp beta120_r_wheat
  save `f_wheat120', replace
restore

// Soybean 120‐day rolling beta
preserve
  rangestat (reg) r_soybean r_sp, interval(date -119 0)
  keep date b_r_sp
  rename b_r_sp beta120_r_soybean
  save `f_soy120', replace
restore

// Merge each 120‐day beta file back into the master dataset
merge 1:1 date using `f_wti120'
drop _merge
merge 1:1 date using `f_brent120'
drop _merge
merge 1:1 date using `f_nat120'
drop _merge
merge 1:1 date using `f_corn120'
drop _merge
merge 1:1 date using `f_wheat120'
drop _merge
merge 1:1 date using `f_soy120'
drop _merge

// Save the updated dataset including 120‐day betas, replacing existing file
save vix_all_frequencies.dta, replace
// Declare date as the time‐series index
tsset date
// Define a local macro “assets” listing all asset identifiers
local assets wti brent natgas corn wheat soybean sp
// Set the graphics scheme to “journal” for a clean, publication style
set scheme journal
// Load the dataset into memory, clearing anything already there
use vix_all_frequencies.dta, clear
// Re‐declare date as the time‐series index
tsset date
// Re‐define “assets” (same list) for subsequent use
local assets wti brent natgas corn wheat soybean sp
// Define window start dates and sample end date
local start30  = td(01feb1990)   // 1 Feb 1990
local start60  = td(01mar1990)   // 1 Mar 1990
local start120 = td(01may1990)   // 1 May 1990
local end      = td(31dec2024)   // 31 Dec 2024

// Loop over each asset to plot rolling betas
foreach a in `assets' {
    // Create a nicely formatted title: proper‐case, except “sp” → “S&P500”
    local Asset = proper("`a'")
    if "`a'" == "sp" local Asset = "S&P500"
    // Plot 30/60/120-day rolling β on one line, add β=1 reference, set ranges, legend, titles, and formatting
    twoway line beta30_r_`a' date if date>=`start30', lcolor(red) lwidth(medium) || line beta60_r_`a' date if date>=`start60', lcolor(blue) lwidth(medium) || line beta120_r_`a' date if date>=`start120', lcolor(black) lwidth(medium) yline(1, lpattern(dash) lcolor(red) lwidth(thin)) yscale(range(-3 3)) legend(order(1 "30-day" 2 "60-day" 3 "120-day") cols(1) size(vsmall)) title("Rolling β: `Asset' (30/60/120-day)", size(small)) subtitle("Feb/Mar/May 1990–Dec 2024", size(vsmall) color(gs8)) xtitle("Date", size(vsmall)) ytitle("β", size(vsmall)) xlabel(, format(%tdCY) labsize(vsmall) angle(45) grid) ylabel(-3(1)3, labsize(vsmall) angle(horizontal) grid) graphregion(color(white)) bgcolor(white) name(rolling_`a', replace)
    // Save the graph in Stata’s native format
    graph save rolling_beta30_60_120_`a'.gph, replace
    // Export the graph as a 1,200-pixel-wide PNG
    graph export rolling_beta30_60_120_`a'.png, replace width(1200)
}


// natural gas + brent + wti 30
twoway (line beta30_r_wti    date if date>=`start30', lcolor(red)   lwidth(medium)) (line beta30_r_brent date if date>=`start30', lcolor(blue)  lwidth(medium)) (line beta30_r_natgas date if date>=`start30', lcolor(black) lwidth(medium)), yline(1, lpattern(dash) lcolor(red) lwidth(thin)) yscale(range(-3 3)) legend(order(1 "WTI" 2 "Brent" 3 "NatGas") cols(1) size(vsmall)) title("30-Day Rolling Beta: WTI vs. Brent vs. NatGas", size(small)) subtitle("Feb 1990–Dec 2024", size(vsmall) color(gs8)) xtitle("Date", size(vsmall)) ytitle("Beta", size(vsmall)) xlabel(, format(%tdCY) labsize(vsmall) angle(45) grid) ylabel(-3(1)3, labsize(vsmall) angle(horizontal) grid) graphregion(color(white)) bgcolor(white) name(beta30_wti_brent_natgas, replace)
graph save beta30_wti_brent_natgas.gph, replace

//soybean, corn wheat 30
twoway (line beta30_r_soybean date if date>=`start30', lcolor(red)   lwidth(medium)) (line beta30_r_wheat date if date>=`start30', lcolor(blue)  lwidth(medium)) (line beta30_r_corn    date if date>=`start30', lcolor(black) lwidth(medium)), yline(1, lpattern(dash) lcolor(red) lwidth(thin)) yscale(range(-3 3)) legend(order(1 "Soybean" 2 "Wheat" 3 "Corn") cols(1) size(vsmall)) title("30-Day Rolling Beta: Soybean, Wheat & Corn", size(small)) subtitle("Feb 1990–Dec 2024", size(vsmall) color(gs8)) xtitle("Date", size(vsmall)) ytitle("Beta", size(vsmall)) xlabel(, format(%tdCY) labsize(vsmall) angle(45) grid) ylabel(-3(1)3, labsize(vsmall) angle(horizontal) grid) graphregion(color(white)) bgcolor(white) name(beta30_soy_wheat_corn, replace)
graph save beta30_soy_wheat_corn.gph, replace

//natural gas + brent + wti 60
twoway (line beta60_r_wti    date if date>=`start60', lcolor(red)   lwidth(medium)) (line beta60_r_brent date if date>=`start60', lcolor(blue)  lwidth(medium)) (line beta60_r_natgas  date if date>=`start60', lcolor(black) lwidth(medium)), yline(1, lpattern(dash) lcolor(red) lwidth(thin)) yscale(range(-3 3)) legend(order(1 "WTI" 2 "Brent" 3 "NatGas") cols(1) size(vsmall)) title("60-Day Rolling Beta: WTI vs. Brent vs. NatGas", size(small)) subtitle("Mar 1990–Dec 2024", size(vsmall) color(gs8)) xtitle("Date", size(vsmall)) ytitle("Beta", size(vsmall)) xlabel(, format(%tdCY) labsize(vsmall) angle(45) grid) ylabel(-3(1)3, labsize(vsmall)) graphregion(color(white)) bgcolor(white) name(beta60_wti_brent_natgas, replace)
graph save beta60_wti_brent_natgas.gph, replace

//soybean, corn wheat 60
twoway (line beta60_r_soybean date if date>=`start60', lcolor(red)   lwidth(medium)) (line beta60_r_wheat   date if date>=`start60', lcolor(blue)  lwidth(medium)) (line beta60_r_corn    date if date>=`start60', lcolor(black) lwidth(medium)), yline(1, lpattern(dash) lcolor(red) lwidth(thin)) yscale(range(-3 3)) legend(order(1 "Soybean" 2 "Wheat" 3 "Corn") cols(1) size(vsmall)) title("60-Day Rolling Beta: Soybean, Wheat & Corn", size(small)) subtitle("Mar 1990–Dec 2024", size(vsmall) color(gs8)) xtitle("Date", size(vsmall)) ytitle("Beta", size(vsmall)) xlabel(, format(%tdCY) labsize(vsmall) angle(45) grid) ylabel(-3(1)3, labsize(vsmall)) graphregion(color(white)) bgcolor(white) name(beta60_soy_wheat_corn, replace)
graph save beta60_soy_wheat_corn.gph, replace

//natural gas + brent + wti 120
twoway (line beta120_r_wti    date if date>=`start120', lcolor(red)   lwidth(medium)) (line beta120_r_brent date if date>=`start120', lcolor(blue)  lwidth(medium)) (line beta120_r_natgas  date if date>=`start120', lcolor(black) lwidth(medium)), yline(1, lpattern(dash) lcolor(red) lwidth(thin)) yscale(range(-3 3)) legend(order(1 "WTI" 2 "Brent" 3 "NatGas") cols(1) size(vsmall)) title("120-Day Rolling Beta: WTI vs. Brent vs. NatGas", size(small)) subtitle("May 1990–Dec 2024", size(vsmall) color(gs8)) xtitle("Date", size(vsmall)) ytitle("Beta", size(vsmall)) xlabel(, format(%tdCY) labsize(vsmall) angle(45) grid) ylabel(-3(1)3, labsize(vsmall)) graphregion(color(white)) bgcolor(white) name(beta120_wti_brent_natgas, replace)
graph save beta120_wti_brent_natgas.gph, replace

//soybean, corn wheat 120
twoway (line beta120_r_soybean date if date>=`start120', lcolor(red)   lwidth(medium)) (line beta120_r_wheat   date if date>=`start120', lcolor(blue)  lwidth(medium)) (line beta120_r_corn    date if date>=`start120', lcolor(black) lwidth(medium)), yline(1, lpattern(dash) lcolor(red) lwidth(thin)) yscale(range(-3 3)) legend(order(1 "Soybean" 2 "Wheat" 3 "Corn") cols(1) size(vsmall)) title("120-Day Rolling Beta: Soybean, Wheat & Corn", size(small)) subtitle("May 1990–Dec 2024", size(vsmall) color(gs8)) xtitle("Date", size(vsmall)) ytitle("Beta", size(vsmall)) xlabel(, format(%tdCY) labsize(vsmall) angle(45) grid) ylabel(-3(1)3, labsize(vsmall)) graphregion(color(white)) bgcolor(white) name(beta120_soy_wheat_corn, replace)
graph save beta120_soy_wheat_corn.gph, replace

// Create a byte‐type flag GFC = 1 for dates from 15 Sep 2008 through 9 Mar 2009
gen byte GFC   = inrange(date, td(15sep2008), td(9mar2009))
// Attach a descriptive label “Great Financial Crisis” to the GFC variable
label var GFC  "Great Financial Crisis"
// Create a byte‐type flag COVID = 1 for dates from 20 Feb 2020 through 30 Apr 2020
gen byte COVID = inrange(date, td(20feb2020), td(30apr2020))
// Attach a descriptive label “COVID-19 shock” to the COVID variable
label var COVID "COVID-19 shock"
// Define a local macro “suffix” listing the asset codes to loop over
local suffix    wti brent natgas corn wheat soybean
// Define a second local macro “pretty” with human‐readable names matching `suffix’ order
local pretty    WTI Brent "Natural gas" Corn Wheat Soybean
// Define a cutoff date macro for 1 Jan 2025 to restrict analyses/plots
local cutoff    = td(1jan2025)

// Loop for GFC and Covid
local i = 1
foreach c of local suffix {
    local pname : word `i' of `pretty'
    quietly summarize beta60_r_`c' if date<`cutoff'
    local ymin = r(min)
    local ymax = r(max)
    tempvar shade
    gen double `shade' = (`ymax' - `ymin') if GFC==1 | COVID==1
    twoway (bar `shade' date if date<`cutoff', barwidth(1) base(`ymin') fcolor(gs12%30)) (line beta60_r_`c' date if date<`cutoff', lcolor(black) lwidth(medium)), scheme(s1color) title("`pname' 60-Day Rolling β", size(medium)) subtitle("Shaded: Great Financial Crisis & COVID-19", size(small)) xtitle("Date", size(small)) ytitle("β₆₀", size(small)) xlabel(, format(%tdCY) angle(45) labsize(vsmall)) ylabel(, grid labsize(vsmall)) yline(1, lpattern(dash) lcolor(red)) legend(off) graphregion(color(white)) plotregion(margin(5 5 5 5)) aspectratio(0.6) name(rolling60_`c', replace)
    local ++i
}

graph combine rolling60_wti rolling60_brent rolling60_natgas rolling60_corn rolling60_wheat rolling60_soybean, cols(3) xcommon ycommon imargin(zero) title("60-Day Rolling β for Oil, Gas & Grains") subtitle("Shaded: Great Financial Crisis & COVID-19") name(rolling60_all, replace)

//Loop for 90th percentile VIX method
foreach c of local suffix {
    local pname : word `i' of `pretty'
    quietly summarize beta60_r_`c' if date<`cutoff'
    local ymin = r(min)
    local ymax = r(max)
    tempvar shade
    gen double `shade' = (`ymax'-`ymin') if crisis10==1
    twoway (bar `shade' date if date<`cutoff', barwidth(1) base(`ymin') fcolor(gs12%20)) (line beta60_r_`c' date if date<`cutoff', lcolor(black) lwidth(medium)), scheme(s1color) title("`pname' 60-Day Rolling β", size(medium)) subtitle("Shaded: VIX top decile", size(small)) xtitle("Date", size(small)) ytitle("β₆₀", size(small)) xlabel(, format(%tdCY) angle(45) labsize(vsmall)) ylabel(, grid labsize(vsmall)) yline(1, lpattern(dash) lcolor(red)) legend(off) graphregion(color(white)) plotregion(margin(5 5 5 5)) aspectratio(0.6) name(rolling60_vix_`c', replace)
    local ++i
}

graph combine rolling60_vix_wti rolling60_vix_brent rolling60_vix_natgas rolling60_vix_corn rolling60_vix_wheat rolling60_vix_soybean, cols(3) xcommon ycommon imargin(zero) title("60-Day Rolling β — VIX Top Decile") subtitle("Shaded: VIX ≥ 90th percentile") name(rolling60_vix_all, replace)

/// Load the dataset “vix_all_frequencies.dta” into memory, replacing any data already present
use vix_all_frequencies.dta, clear
/// Define a local macro “assets” containing the list of return‐series variables to model with GARCH
local assets r_wti r_brent r_natgas_d r_corn_d r_wheat_d r_soybean_d
/// Create a temporary name for the handle that will refer to our postfile
tempname garch_handle
/// Open (or replace) a postfile called “garch_ic.dta” using the handle `garch_handle’
/// The postfile will store:
///   • asset  : a 20‐character string identifying each series
///   • ll     : the log‐likelihood from the GARCH estimation
///   • aic    : Akaike Information Criterion value
///   • bic    : Bayesian Information Criterion value
postfile `garch_handle' str20 asset double ll double aic double bic using garch_ic.dta, replace

foreach a of local assets {
    display as text "Estimating Gaussian GARCH(1,1) for `a'"
    arch `a', arch(1) garch(1) distribution(normal) nocons
    local ll = e(ll)          
    local k  = e(df_m)        
    local n  = e(N)           
    local aic = `=-2*`ll' + 2*`k''
    local bic = `=-2*`ll' + ln(`n')*`k''
    post `handle' ("`a'") (`ll') (`aic') (`bic')
    display as text ""
}
postclose `garch_handle'

//HVAR 
local grains r_corn_d r_wheat_d r_soybean_d
matrix results = J(3,6,.)
local i = 1
foreach a of local grains {
    display as text "Running HAR‐RV regression for `a'  ..."
    gen rv_`a' = `a'^2
    rangestat (mean) rv_w=rv_`a', interval(date -4 0)
    rangestat (mean) rv_m=rv_`a', interval(date -22 0)
    drop if missing(L.rv_`a') | missing(rv_w) | missing(rv_m)
    quietly regress rv_`a' L.rv_`a' rv_w rv_m
    matrix results[`i',1] = _b[L.rv_`a']
    matrix results[`i',2] = _se[L.rv_`a']
    matrix results[`i',3] = _b[rv_w]
    matrix results[`i',4] = _se[rv_w]
    matrix results[`i',5] = _b[rv_m]
    matrix results[`i',6] = _se[rv_m]
    local ++i
    drop rv_`a' rv_w rv_m
} 

//Graphing GARCH volatility
local vars r_corn_d r_wheat_d r_soybean_d
local cols navy forest_red maroon

set scheme journal

local i = 1
foreach x of local vars {
    local col : word `i' of `cols'

    tsline `x', scheme(journal) name(g_`x', replace) title("Time Series of `x'", size(medium) color(black)) xtitle("Date", size(small) color(black)) ytitle("Return (%)", size(small) color(black)) ylabel(, labsize(vsmall) angle(horizontal) grid) xlabel(, labsize(vsmall) format(%tdCY) angle(45) grid) lcolor(`col') lwidth(medium) legend(off) graphregion(color(white)) bgcolor(white)

    graph save "graph_`x'.gph", replace
    graph export "tsplot_`x'.png", name(g_`x') replace

    su `x'
    sktest `x'
    local ++i
}

//Durbin-Watson
tempname dwstats
postfile `dwstats' str12 series double d using dwstats.dta, replace

//loop over each asset class
foreach x in r_sp r_brent r_wti r_natgas r_corn r_wheat r_soybean {
    quietly regress `x'
    quietly estat dwatson           
    local d = r(dw)                
    post `dwstats' ("`x'") (`d')
}

postclose `dwstats'
use dwstats.dta, clear

label var series “Return series”
label var d      “Durbin–Watson d”
list, noobs clean

/// Computing hedge ratio

ssc install rangestat, replace
use vix_all_frequencies.dta, clear
tsset date
tempfile f_hwti f_hsoy f_hwheat f_hcorn f_hnat f_hbre

// WTI
preserve
    gen sp_wti        = r_sp * r_wti
    gen wti2          = r_wti^2
    rangestat (sum) r_sp r_wti sp_wti wti2 (count) r_sp, interval(date -59 0)
    rename r_sp_sum    sum_sp
    rename r_wti_sum   sum_wti
    rename sp_wti_sum  sum_spwti
    rename wti2_sum    sum_sq_wti
    rename r_sp_count  n_obs
    gen m_sp        = sum_sp    / n_obs
    gen m_wti       = sum_wti   / n_obs
    gen m_spwti     = sum_spwti / n_obs
    gen m_wti2      = sum_sq_wti/ n_obs
    gen cov_sp_wti  = m_spwti - m_sp*m_wti
    gen var_wti     = m_wti2   - m_wti*m_wti
    gen hedge_wti60 = cov_sp_wti / var_wti
    keep date hedge_wti60
    save `f_hwti', replace
restore

// Soybean
preserve
    gen sp_soybean_d      = r_sp * r_soybean_d
    gen soybean_d2        = r_soybean_d^2
    rangestat (sum) r_sp r_soybean_d sp_soybean_d soybean_d2 (count) r_sp, interval(date -59 0)
    rename r_sp_sum            sum_sp
    rename r_soybean_d_sum     sum_soybean_d
    rename sp_soybean_d_sum    sum_sopsy
    rename soybean_d2_sum      sum_sq_soy
    rename r_sp_count          n_obs
    gen m_sp              = sum_sp        / n_obs
    gen m_soybean_d       = sum_soybean_d / n_obs
    gen m_sopsy           = sum_sopsy     / n_obs
    gen m_soy2            = sum_sq_soy    / n_obs
    gen cov_sp_soybean_d  = m_sopsy - m_sp*m_soybean_d
    gen var_soybean_d     = m_soy2  - m_soybean_d*m_soybean_d
    gen hedge_soybean_d60 = cov_sp_soybean_d / var_soybean_d
    keep date hedge_soybean_d60
    save `f_hsoy', replace
restore

// Wheat
preserve
    gen sp_wheat_d     = r_sp * r_wheat_d
    gen wheat_d2       = r_wheat_d^2
    rangestat (sum) r_sp r_wheat_d sp_wheat_d wheat_d2 (count) r_sp, interval(date -59 0)
    rename r_sp_sum        sum_sp
    rename r_wheat_d_sum   sum_wheat_d
    rename sp_wheat_d_sum  sum_spwheat
    rename wheat_d2_sum    sum_sq_wheat
    rename r_sp_count      n_obs
    gen m_sp            = sum_sp       / n_obs
    gen m_wheat_d       = sum_wheat_d  / n_obs
    gen m_spwheat       = sum_spwheat  / n_obs
    gen m_wheat2        = sum_sq_wheat / n_obs
    gen cov_sp_wheat_d  = m_spwheat - m_sp*m_wheat_d
    gen var_wheat_d     = m_wheat2  - m_wheat_d*m_wheat_d
    gen hedge_wheat_d60 = cov_sp_wheat_d / var_wheat_d
    keep date hedge_wheat_d60
    save `f_hwheat', replace
restore

// Corn
preserve
    gen sp_corn_d      = r_sp * r_corn_d
    gen corn_d2        = r_corn_d^2
    rangestat (sum) r_sp r_corn_d sp_corn_d corn_d2 (count) r_sp, interval(date -59 0)
    rename r_sp_sum       sum_sp
    rename r_corn_d_sum   sum_corn_d
    rename sp_corn_d_sum  sum_spcorn
    rename corn_d2_sum    sum_sq_corn
    rename r_sp_count     n_obs
    gen m_sp           = sum_sp      / n_obs
    gen m_corn_d       = sum_corn_d  / n_obs
    gen m_spcorn       = sum_spcorn  / n_obs
    gen m_corn2        = sum_sq_corn / n_obs
    gen cov_sp_corn_d  = m_spcorn - m_sp*m_corn_d
    gen var_corn_d     = m_corn2  - m_corn_d*m_corn_d
    gen hedge_corn_d60 = cov_sp_corn_d / var_corn_d
    keep date hedge_corn_d60
    save `f_hcorn', replace
restore

// NatGas
preserve
    gen sp_natgas_d    = r_sp * r_natgas_d
    gen natgas_d2      = r_natgas_d^2
    rangestat (sum) r_sp r_natgas_d sp_natgas_d natgas_d2 (count) r_sp, interval(date -59 0)
    rename r_sp_sum        sum_sp
    rename r_natgas_d_sum  sum_natgas_d
    rename sp_natgas_d_sum sum_spnat
    rename natgas_d2_sum   sum_sq_nat
    rename r_sp_count      n_obs
    gen m_sp            = sum_sp       / n_obs
    gen m_natgas_d      = sum_natgas_d / n_obs
    gen m_spnat         = sum_spnat    / n_obs
    gen m_natgas2       = sum_sq_nat   / n_obs
    gen cov_sp_natgas_d = m_spnat - m_sp*m_natgas_d
    gen var_natgas_d    = m_natgas2 - m_natgas_d*m_natgas_d
    gen hedge_natgas_d60 = cov_sp_natgas_d / var_natgas_d
    keep date hedge_natgas_d60
    save `f_hnat', replace
restore

// Brent
preserve
    gen sp_brent       = r_sp * r_brent
    gen brent2         = r_brent^2
    rangestat (sum) r_sp r_brent sp_brent brent2 (count) r_sp, interval(date -59 0)
    rename r_sp_sum       sum_sp
    rename r_brent_sum    sum_brent
    rename sp_brent_sum   sum_spbre
    rename brent2_sum     sum_sq_bre
    rename r_sp_count     n_obs
    gen m_sp            = sum_sp       / n_obs
    gen m_brent         = sum_brent    / n_obs
    gen m_spbre         = sum_spbre    / n_obs
    gen m_bre2          = sum_sq_bre   / n_obs
    gen cov_sp_brent    = m_spbre - m_sp*m_brent
    gen var_brent       = m_bre2  - m_brent*m_brent
    gen hedge_brent60   = cov_sp_brent / var_brent
    keep date hedge_brent60
    save `f_hbre', replace
restore

use vix_all_frequencies.dta, clear
tsset date

merge 1:1 date using `f_hwti'
drop _merge
merge 1:1 date using `f_hsoy'
drop _merge
merge 1:1 date using `f_hwheat'
drop _merge
merge 1:1 date using `f_hcorn'
drop _merge
merge 1:1 date using `f_hnat'
drop _merge
merge 1:1 date using `f_hbre'
drop _merge

list date r_sp r_brent hedge_brent60 in 200/205, clean noobs

//Graphing
gen hedge_brent60_trunc     = cond(hedge_brent60     > 3, 3, cond(hedge_brent60     < -3, -3, hedge_brent60))
gen hedge_wti60_trunc       = cond(hedge_wti60       > 3, 3, cond(hedge_wti60       < -3, -3, hedge_wti60))
gen hedge_natgas_d60_trunc  = cond(date >= td(01jan1997), cond(hedge_natgas_d60 > 3, 3, cond(hedge_natgas_d60 < -3, -3, hedge_natgas_d60)), .)
gen hedge_corn_d60_trunc    = cond(hedge_corn_d60    > 3, 3, cond(hedge_corn_d60    < -3, -3, hedge_corn_d60))
gen hedge_soybean_d60_trunc = cond(hedge_soybean_d60 > 3, 3, cond(hedge_soybean_d60 < -3, -3, hedge_soybean_d60))
gen hedge_wheat_d60_trunc   = cond(hedge_wheat_d60   > 3, 3, cond(hedge_wheat_d60   < -3, -3, hedge_wheat_d60))

twoway (line hedge_brent60_trunc date, lcolor(blue) lwidth(medium)) (line hedge_wti60_trunc date, lcolor(red) lwidth(medium)) (line hedge_natgas_d60_trunc date, lcolor(green) lwidth(medium)), title("60-Day Rolling Hedge Ratios: Oil & Gas", size(medsmall)) subtitle("1990–2024", size(vsmall) color(gs8)) ytitle("Hedge Ratio", size(small)) xtitle("Date", size(small)) xlabel(, format(%tdCY) labsize(vsmall) angle(45) grid) ylabel(-3(1)3, labsize(vsmall) grid) yscale(range(-3 3) noextend) legend(order(1 "Brent" 2 "WTI" 3 "NatGas") size(vsmall) cols(1) ring(0) pos(1)) yline(0, lcolor(gs12) lpattern(dash)) graphregion(color(white) lcolor(black) lwidth(thin)) plotregion(margin(5 5 5 5)) bgcolor(white) scheme(s1color) name(hedge_ratio_overlay_oilgas_t3, replace)
graph save hedge_ratio_overlay_oilgas_t3.gph, replace
graph export hedge_ratio_overlay_oilgas_t3.png, replace width(1800)

twoway (line hedge_corn_d60_trunc date, lcolor(black) lwidth(medium)) (line hedge_soybean_d60_trunc date, lcolor(dkorange) lwidth(medium)) (line hedge_wheat_d60_trunc date, lcolor(maroon) lwidth(medium)), title("60-Day Rolling Hedge Ratios: Grains", size(medsmall)) subtitle("1990–2024", size(vsmall) color(gs8)) ytitle("Hedge Ratio", size(small)) xtitle("Date", size(small)) xlabel(, format(%tdCY) labsize(vsmall) angle(45) grid) ylabel(-3(1)3, labsize(vsmall) grid) yscale(range(-3 3) noextend) legend(order(1 "Corn" 2 "Soybean" 3 "Wheat") size(vsmall) cols(1) ring(0) pos(1)) yline(0, lcolor(gs12) lpattern(dash)) graphregion(color(white) lcolor(black) lwidth(thin)) plotregion(margin(5 5 5 5)) bgcolor(white) scheme(s1color) name(hedge_ratio_overlay_grains_t3, replace)
graph save hedge_ratio_overlay_grains_t3.gph, replace
graph export hedge_ratio_overlay_grains_t3.png, replace width(1800)

gen hedge_corn_d60_t10    = cond(hedge_corn_d60 > 10, 10, cond(hedge_corn_d60 < -10, -10, hedge_corn_d60))
gen hedge_soybean_d60_t10 = cond(hedge_soybean_d60 > 10, 10, cond(hedge_soybean_d60 < -10, -10, hedge_soybean_d60))
gen hedge_wheat_d60_t10   = cond(hedge_wheat_d60 > 10, 10, cond(hedge_wheat_d60 < -10, -10, hedge_wheat_d60))

twoway (line hedge_corn_d60_t10 date, lcolor(black) lwidth(medium)), title("60-Day Hedge Ratio (±10): Corn", size(medsmall)) subtitle("1990–2024", size(vsmall) color(gs8)) ytitle("Hedge Ratio", size(small)) xtitle("Date", size(small)) xlabel(, format(%tdCY) labsize(vsmall) angle(45) grid) ylabel(-10(5)10, labsize(vsmall) grid) yline(0, lcolor(gs12) lpattern(dash)) legend(off) graphregion(color(white) lcolor(black) lwidth(thin)) plotregion(margin(5 5 5 5)) bgcolor(white) scheme(s1color) name(hedge_ratio_corn_t10, replace)
graph save hedge_ratio_corn_t10.gph, replace
graph export hedge_ratio_corn_t10.png, replace width(1800)

twoway (line hedge_soybean_d60_t10 date, lcolor(dkorange) lwidth(medium)), title("60-Day Hedge Ratio (±10): Soybean", size(medsmall)) subtitle("1990–2024", size(vsmall) color(gs8)) ytitle("Hedge Ratio", size(small)) xtitle("Date", size(small)) xlabel(, format(%tdCY) labsize(vsmall) angle(45) grid) ylabel(-10(5)10, labsize(vsmall) grid) yline(0, lcolor(gs12) lpattern(dash)) legend(off) graphregion(color(white) lcolor(black) lwidth(thin)) plotregion(margin(5 5 5 5)) bgcolor(white) scheme(s1color) name(hedge_ratio_soybean_t10, replace)
graph save hedge_ratio_soybean_t10.gph, replace
graph export hedge_ratio_soybean_t10.png, replace width(1800)

twoway (line hedge_wheat_d60_t10 date, lcolor(maroon) lwidth(medium)), title("60-Day Hedge Ratio (±10): Wheat", size(medsmall)) subtitle("1990–2024", size(vsmall) color(gs8)) ytitle("Hedge Ratio", size(small)) xtitle("Date", size(small)) xlabel(, format(%tdCY) labsize(vsmall) angle(45) grid) ylabel(-10(5)10, labsize(vsmall) grid) yline(0, lcolor(gs12) lpattern(dash)) legend(off) graphregion(color(white) lcolor(black) lwidth(thin)) plotregion(margin(5 5 5 5)) bgcolor(white) scheme(s1color) name(hedge_ratio_wheat_t10, replace)
graph save hedge_ratio_wheat_t10.gph, replace
graph export hedge_ratio_wheat_t10.png, replace width(1800)
